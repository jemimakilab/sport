<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playbook 2026 - Fitness Tracker</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            color: var(--light);
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        header .subtitle {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            animation: pulse 2s infinite;
        }

        .alert-banner.show {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .alert-banner h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .alert-banner p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Progress Section */
        .progress-container {
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-box .label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Today's Training */
        .training-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .training-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .training-badge.day-a {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .training-badge.day-b {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        }

        .training-badge.cheat {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .workout-details {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .workout-details h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .workout-details ul {
            list-style: none;
            padding-left: 0;
        }

        .workout-details li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .workout-details li:last-child {
            border-bottom: none;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .form-group input[type="number"],
        .form-group input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            flex: 1;
            min-width: 120px;
        }

        .checkbox-item input[type="checkbox"] {
            display: none;
        }

        .checkbox-item label {
            display: block;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .checkbox-item input:checked + label {
            background: rgba(22, 163, 74, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #1d4ed8);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #15803d);
            color: white;
        }

        /* History */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .history-data {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .history-tag.success {
            background: rgba(22, 163, 74, 0.2);
            color: var(--success);
        }

        .history-tag.warning {
            background: rgba(234, 88, 12, 0.2);
            color: var(--warning);
        }

        /* Streak */
        .streak-display {
            text-align: center;
            padding: 20px;
        }

        .streak-number {
            font-size: 4rem;
            font-weight: bold;
            background: linear-gradient(135deg, #f59e0b, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .streak-label {
            font-size: 1rem;
            color: var(--gray);
        }

        /* Weekly Average */
        .weekly-avg {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
        }

        .weekly-item {
            text-align: center;
        }

        .weekly-item .value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .weekly-item .label {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .trend-up { color: var(--danger); }
        .trend-down { color: var(--success); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--gray);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quarter Goals */
        .quarter-goals {
            display: grid;
            gap: 10px;
        }

        .quarter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .quarter-item.achieved {
            border-left: 3px solid var(--success);
        }

        .quarter-item.current {
            border-left: 3px solid var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .quarter-item.future {
            opacity: 0.6;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .checkbox-item {
                min-width: 100px;
            }
        }

        /* Workout Rotation Indicator */
        .rotation-indicator {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .rotation-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .rotation-dot.active {
            background: var(--primary);
        }

        .rotation-dot.b1 { background: #ef4444; }
        .rotation-dot.b2 { background: #3b82f6; }
        .rotation-dot.b3 { background: #22c55e; }

        /* ============ GAMIFICATION STYLES ============ */

        /* XP Bar */
        .xp-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .level-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .level-badge {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        .level-info h3 {
            font-size: 1.1rem;
            margin-bottom: 2px;
        }

        .level-info span {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .xp-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .xp-text {
            text-align: right;
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Medals Grid */
        .medals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .medal-item {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .medal-item.locked {
            opacity: 0.4;
            filter: grayscale(100%);
        }

        .medal-item.unlocked {
            border-color: #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
        }

        .medal-item.unlocked::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .medal-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .medal-name {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .medal-desc {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .medal-item.unlocked .medal-date {
            font-size: 0.65rem;
            color: #fbbf24;
            margin-top: 5px;
        }

        /* Challenges */
        .challenge-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .challenge-card.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .challenge-card.completed {
            border-color: var(--success);
            background: rgba(22, 163, 74, 0.1);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .challenge-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .challenge-title .icon {
            font-size: 1.3rem;
        }

        .challenge-reward {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .challenge-progress {
            margin-top: 10px;
        }

        .challenge-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .challenge-card.completed .challenge-progress-fill {
            background: var(--success);
        }

        .challenge-status {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Weekly Challenge Special */
        .weekly-challenge {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(109, 40, 217, 0.2));
            border: 2px solid #8b5cf6;
        }

        .weekly-challenge .challenge-reward {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
        }

        /* Rewards Section */
        .reward-unlock {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 3px solid #fbbf24;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 1000;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .reward-unlock.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .reward-unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: none;
        }

        .reward-unlock-overlay.show {
            display: block;
        }

        .reward-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 0.5s ease infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .reward-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 10px;
        }

        .reward-xp {
            font-size: 1.2rem;
            color: var(--success);
        }

        .reward-close {
            margin-top: 20px;
            padding: 10px 30px;
            background: #fbbf24;
            color: #1e293b;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Streak Milestones */
        .streak-milestones {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .milestone {
            text-align: center;
            opacity: 0.4;
        }

        .milestone.achieved {
            opacity: 1;
        }

        .milestone.next {
            opacity: 0.7;
            color: var(--primary);
        }

        .milestone-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .milestone-days {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Leaderboard / Stats */
        .total-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .total-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .total-stat .num {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
        }

        .total-stat .lbl {
            font-size: 0.7rem;
            color: var(--gray);
        }

        /* Tabs adjustment for more tabs */
        .tabs {
            flex-wrap: wrap;
        }

        .tab {
            font-size: 0.8rem;
            padding: 8px 5px;
        }

        @media (max-width: 600px) {
            .medals-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .tab {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PLAYBOOK 2026</h1>
            <p class="subtitle">Ziel: 89,9 kg bis 23. Dezember 2026</p>
            <p class="subtitle" id="currentDate" style="margin-top: 5px; font-size: 0.85rem;"></p>
        </header>

        <!-- Never Miss Twice Alert -->
        <div class="alert-banner" id="alertBanner">
            <h3>‚ö†Ô∏è NEVER MISS TWICE!</h3>
            <p>Du hast gestern kein Training gemacht. Heute ist NICHT verhandelbar!</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="entry">Eintragen</button>
            <button class="tab" data-tab="achievements">Erfolge</button>
            <button class="tab" data-tab="history">Verlauf</button>
            <button class="tab" data-tab="workouts">Workouts</button>
        </div>

        <!-- XP Bar (shows on all tabs) -->
        <div class="xp-container" id="xpContainer">
            <div class="level-display">
                <div class="level-badge">
                    <div class="level-icon" id="levelIcon">1</div>
                    <div class="level-info">
                        <h3 id="levelTitle">Anf√§nger</h3>
                        <span id="totalXP">0 XP gesamt</span>
                    </div>
                </div>
            </div>
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill" style="width: 0%"></div>
            </div>
            <div class="xp-text" id="xpText">0 / 100 XP zum n√§chsten Level</div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <!-- Progress Card -->
            <div class="card">
                <h2>üìä Fortschritt zum Ziel</h2>
                <div class="progress-container">
                    <div class="progress-header">
                        <span id="currentWeight">-- kg</span>
                        <span>Ziel: 89,9 kg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="weightLost">--</div>
                        <div class="label">kg verloren</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="weightToGo">--</div>
                        <div class="label">kg noch</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="daysLeft">--</div>
                        <div class="label">Tage √ºbrig</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="weeklyAvg">--</div>
                        <div class="label">√ò 7 Tage</div>
                    </div>
                </div>
            </div>

            <!-- Streak Card -->
            <div class="card">
                <h2>üî• Training Streak</h2>
                <div class="streak-display">
                    <div class="streak-number" id="streakCount">0</div>
                    <div class="streak-label">Tage in Folge trainiert</div>
                </div>
            </div>

            <!-- Today's Training -->
            <div class="card">
                <h2>üí™ Heute</h2>
                <div class="training-type">
                    <span class="training-badge" id="todayBadge">--</span>
                </div>
                <div class="workout-details" id="todayWorkout">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Weekly Overview -->
            <div class="card">
                <h2>üìà Diese Woche</h2>
                <div class="weekly-avg">
                    <div class="weekly-item">
                        <div class="value" id="avgCalories">--</div>
                        <div class="label">√ò Kalorien</div>
                    </div>
                    <div class="weekly-item">
                        <div class="value" id="avgProtein">--</div>
                        <div class="label">√ò Protein</div>
                    </div>
                    <div class="weekly-item">
                        <div class="value" id="trainingDays">-/7</div>
                        <div class="label">Trainingstage</div>
                    </div>
                </div>
            </div>

            <!-- Quarter Goals -->
            <div class="card">
                <h2>üéØ Quartalsziele</h2>
                <div class="quarter-goals" id="quarterGoals">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Entry Tab -->
        <div class="tab-content" id="entry">
            <div class="card">
                <h2>üìù Tageseintrag</h2>
                <form id="dailyForm">
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Gewicht (kg)</label>
                        <input type="number" id="entryWeight" step="0.1" min="50" max="200" placeholder="z.B. 103.5">
                    </div>
                    <div class="form-group">
                        <label>Kalorien</label>
                        <input type="number" id="entryCalories" min="0" max="10000" placeholder="z.B. 2300">
                    </div>
                    <div class="form-group">
                        <label>Protein (g)</label>
                        <input type="number" id="entryProtein" min="0" max="500" placeholder="z.B. 180">
                    </div>
                    <div class="form-group">
                        <label>Checkboxen</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="trainingDone">
                                <label for="trainingDone">‚úÖ Training</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="ifDone">
                                <label for="ifDone">‚è∞ IF 12-20</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cheatDay">
                                <label for="cheatDay">üçï Cheat Day</label>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">üíæ Speichern</button>
                </form>
            </div>

            <!-- Quick Stats After Entry -->
            <div class="card">
                <h2>‚ö° Schnell-Check</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="proteinStatus">--</div>
                        <div class="label">Protein heute</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="calorieStatus">--</div>
                        <div class="label">Kalorien heute</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div class="tab-content" id="achievements">
            <!-- Daily Challenges -->
            <div class="card">
                <h2>‚ö° T√§gliche Herausforderungen</h2>
                <div id="dailyChallenges">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Weekly Challenge -->
            <div class="card">
                <h2>üèÜ Wochenherausforderung</h2>
                <div id="weeklyChallenges">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Medals -->
            <div class="card">
                <h2>üèÖ Medaillen</h2>
                <div class="medals-grid" id="medalsGrid">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Total Stats -->
            <div class="card">
                <h2>üìä Gesamt-Statistiken</h2>
                <div class="total-stats">
                    <div class="total-stat">
                        <div class="num" id="totalTrainings">0</div>
                        <div class="lbl">Trainings</div>
                    </div>
                    <div class="total-stat">
                        <div class="num" id="totalMedals">0</div>
                        <div class="lbl">Medaillen</div>
                    </div>
                    <div class="total-stat">
                        <div class="num" id="bestStreak">0</div>
                        <div class="lbl">Bester Streak</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="history">
            <div class="card">
                <h2>üìÖ Letzte 14 Tage</h2>
                <div class="history-list" id="historyList">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Monthly Stats -->
            <div class="card">
                <h2>üìä Monats√ºbersicht</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="monthStart">--</div>
                        <div class="label">Monatsstart</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="monthCurrent">--</div>
                        <div class="label">Aktuell</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="monthChange">--</div>
                        <div class="label">Ver√§nderung</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="monthTrainings">--</div>
                        <div class="label">Trainings</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workouts Tab -->
        <div class="tab-content" id="workouts">
            <div class="card">
                <h2 style="color: #3b82f6;">üèÉ Tag A: Laufen</h2>
                <div class="workout-details">
                    <p><strong>Phase 1 (Jan W1-4):</strong> 15-30 Min locker</p>
                    <p><strong>Phase 2 (Feb-M√§rz):</strong> 30-45 Min, Intervalle</p>
                    <p><strong>Phase 3 (Apr-Okt):</strong> 40-60 Min Mix</p>
                    <p><strong>Phase 4 (Nov-Dez):</strong> Wintermodus</p>
                    <h4 style="margin-top: 15px;">Indoor-Backup:</h4>
                    <ul>
                        <li>Boxsack: 20-30 Min Intervalle</li>
                        <li>HIIT Bodyweight: 20-25 Min</li>
                        <li>Springseil: 15-20 Min</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2 style="color: #ef4444;">üí™ B1: Push (Brust, Schultern, Trizeps)</h2>
                <div class="workout-details">
                    <ul>
                        <li>KH-Bankdr√ºcken (Boden): 4x8-12</li>
                        <li>KH-Schulterdr√ºcken: 3x10-12</li>
                        <li>KH-Flys: 3x12-15</li>
                        <li>Liegest√ºtze: 3x max</li>
                        <li>KH-Trizepsdr√ºcken: 3x12</li>
                        <li>Dips: 3x max</li>
                        <li>Finisher: Boxsack 3x2 Min</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2 style="color: #3b82f6;">üí™ B2: Pull (R√ºcken, Bizeps)</h2>
                <div class="workout-details">
                    <ul>
                        <li>Klimmz√ºge: 4x max</li>
                        <li>KH-Rudern einarmig: 4x10-12</li>
                        <li>KH-Kreuzheben: 3x10-12</li>
                        <li>Face Pulls: 3x15</li>
                        <li>KH-Curls: 3x12</li>
                        <li>Hammer Curls: 3x12</li>
                        <li>Shrugs: 3x15</li>
                        <li>Finisher: Plank 3x45-60s</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2 style="color: #22c55e;">üí™ B3: Legs + Core</h2>
                <div class="workout-details">
                    <ul>
                        <li>Goblet Squats: 4x12-15</li>
                        <li>KH-Ausfallschritte: 3x10/Bein</li>
                        <li>Rum√§nisches Kreuzheben: 4x10-12</li>
                        <li>Bulgarian Split Squats: 3x10/Bein</li>
                        <li>Wadenheben: 3x20</li>
                        <li>Russian Twists: 3x20</li>
                        <li>Dead Bugs: 3x12</li>
                        <li>Finisher: Boxsack Kicks 3x2 Min</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>üçΩÔ∏è Ern√§hrung Reminder</h2>
                <div class="workout-details">
                    <p><strong>IF-Fenster:</strong> 12:00 - 20:00 Uhr</p>
                    <p><strong>Kalorien:</strong> 2.100-2.400 kcal</p>
                    <p><strong>Protein:</strong> 180g minimum</p>
                    <p><strong>Cheat Day:</strong> Nur Samstag!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reward Unlock Modal -->
    <div class="reward-unlock-overlay" id="rewardOverlay"></div>
    <div class="reward-unlock" id="rewardModal">
        <div class="reward-icon" id="rewardIcon">üèÜ</div>
        <div class="reward-title" id="rewardTitle">Neue Medaille!</div>
        <div class="reward-xp" id="rewardXP">+50 XP</div>
        <button class="reward-close" onclick="closeRewardModal()">Weiter</button>
    </div>

    <script>
        // ============ DATA STORAGE ============
        const STORAGE_KEY = 'playbook2026';
        const START_WEIGHT = 109;
        const GOAL_WEIGHT = 89.9;
        const GOAL_DATE = new Date('2026-12-23');

        // Start date: use first entry date or Jan 1, 2026 (whichever applies)
        function getStartDate() {
            const data = getData();
            const entries = Object.keys(data.entries).sort();
            if (entries.length > 0) {
                const firstEntry = new Date(entries[0] + 'T00:00:00');
                const jan2026 = new Date('2026-01-01');
                return firstEntry < jan2026 ? firstEntry : jan2026;
            }
            // If no entries yet, use today or Jan 2026
            const today = new Date();
            const jan2026 = new Date('2026-01-01');
            return today < jan2026 ? today : jan2026;
        }
        const START_DATE = new Date('2026-01-01'); // Fallback for rotation calc

        // Quarter Goals
        const QUARTER_GOALS = [
            { label: 'Q1 (31. M√§rz)', target: 99.5, date: new Date('2026-03-31') },
            { label: 'Q2 (30. Juni)', target: 95.5, date: new Date('2026-06-30') },
            { label: 'Q3 (30. Sept)', target: 92.5, date: new Date('2026-09-30') },
            { label: 'Q4 (23. Dez)', target: 89.9, date: new Date('2026-12-23') }
        ];

        // Workout rotation
        const WORKOUTS = {
            A: {
                name: 'Tag A: Laufen',
                badge: 'day-a',
                details: 'Ausdauertraining - Laufen oder Indoor-Alternative'
            },
            B1: {
                name: 'B1: Push',
                badge: 'day-b',
                details: 'Brust, Schultern, Trizeps + Boxsack Finisher'
            },
            B2: {
                name: 'B2: Pull',
                badge: 'day-b',
                details: 'R√ºcken, Bizeps + Plank Finisher'
            },
            B3: {
                name: 'B3: Legs + Core',
                badge: 'day-b',
                details: 'Beine, Ges√§√ü, Rumpf + Boxsack Kicks'
            },
            CHEAT: {
                name: 'Cheat Day',
                badge: 'cheat',
                details: 'Ruhetag - Training optional, Ern√§hrung frei'
            }
        };

        // ============ GAMIFICATION SYSTEM ============

        // Level titles and XP requirements
        const LEVELS = [
            { level: 1, title: 'Anf√§nger', xpNeeded: 0 },
            { level: 2, title: 'Rookie', xpNeeded: 100 },
            { level: 3, title: 'Aufsteiger', xpNeeded: 250 },
            { level: 4, title: 'K√§mpfer', xpNeeded: 500 },
            { level: 5, title: 'Athlet', xpNeeded: 800 },
            { level: 6, title: 'Krieger', xpNeeded: 1200 },
            { level: 7, title: 'Champion', xpNeeded: 1700 },
            { level: 8, title: 'Elite', xpNeeded: 2300 },
            { level: 9, title: 'Meister', xpNeeded: 3000 },
            { level: 10, title: 'Legende', xpNeeded: 4000 },
            { level: 11, title: 'Unstoppable', xpNeeded: 5500 },
            { level: 12, title: 'Titan', xpNeeded: 7500 },
            { level: 13, title: 'Gott-Modus', xpNeeded: 10000 }
        ];

        // Medal definitions
        const MEDALS = [
            // Streak Medals
            { id: 'streak_7', icon: 'üî•', name: '7-Tage-Feuer', desc: '7 Tage Streak', xp: 50, check: (stats) => stats.bestStreak >= 7 },
            { id: 'streak_14', icon: 'üí™', name: '2-Wochen-Warrior', desc: '14 Tage Streak', xp: 100, check: (stats) => stats.bestStreak >= 14 },
            { id: 'streak_30', icon: '‚ö°', name: 'Monats-Monster', desc: '30 Tage Streak', xp: 200, check: (stats) => stats.bestStreak >= 30 },
            { id: 'streak_60', icon: 'üèÜ', name: 'Unaufhaltsam', desc: '60 Tage Streak', xp: 400, check: (stats) => stats.bestStreak >= 60 },
            { id: 'streak_100', icon: 'üëë', name: 'Hundert-Tage-K√∂nig', desc: '100 Tage Streak', xp: 750, check: (stats) => stats.bestStreak >= 100 },

            // Training Medals
            { id: 'train_10', icon: 'üéØ', name: 'Erster Meilenstein', desc: '10 Trainings', xp: 30, check: (stats) => stats.totalTrainings >= 10 },
            { id: 'train_25', icon: 'üíé', name: 'Diamant-Disziplin', desc: '25 Trainings', xp: 60, check: (stats) => stats.totalTrainings >= 25 },
            { id: 'train_50', icon: 'üåü', name: 'Halb-Hundert', desc: '50 Trainings', xp: 120, check: (stats) => stats.totalTrainings >= 50 },
            { id: 'train_100', icon: 'üíØ', name: 'Centurion', desc: '100 Trainings', xp: 250, check: (stats) => stats.totalTrainings >= 100 },
            { id: 'train_200', icon: 'ü¶Å', name: 'L√∂wenherz', desc: '200 Trainings', xp: 500, check: (stats) => stats.totalTrainings >= 200 },

            // Weight Loss Medals
            { id: 'weight_5', icon: 'üìâ', name: 'Erste Erfolge', desc: '5 kg verloren', xp: 100, check: (stats) => stats.weightLost >= 5 },
            { id: 'weight_10', icon: 'üéâ', name: 'Zweistellig', desc: '10 kg verloren', xp: 250, check: (stats) => stats.weightLost >= 10 },
            { id: 'weight_15', icon: 'üöÄ', name: 'Transformation', desc: '15 kg verloren', xp: 500, check: (stats) => stats.weightLost >= 15 },
            { id: 'weight_goal', icon: 'üèÅ', name: 'Ziel erreicht!', desc: 'Unter 90 kg', xp: 1000, check: (stats) => stats.currentWeight && stats.currentWeight < 90 },

            // Protein Medals
            { id: 'protein_7', icon: 'ü•©', name: 'Protein-Pro', desc: '7 Tage 180g+ Protein', xp: 75, check: (stats) => stats.proteinStreak >= 7 },
            { id: 'protein_30', icon: 'üçó', name: 'Protein-Meister', desc: '30 Tage 180g+ Protein', xp: 200, check: (stats) => stats.proteinStreak >= 30 },

            // IF Medals
            { id: 'if_14', icon: '‚è∞', name: 'IF-Anf√§nger', desc: '14 Tage IF eingehalten', xp: 50, check: (stats) => stats.ifStreak >= 14 },
            { id: 'if_30', icon: 'üïê', name: 'IF-Profi', desc: '30 Tage IF eingehalten', xp: 100, check: (stats) => stats.ifStreak >= 30 },
            { id: 'if_60', icon: '‚åõ', name: 'IF-Meister', desc: '60 Tage IF eingehalten', xp: 200, check: (stats) => stats.ifStreak >= 60 },

            // Perfect Week Medals
            { id: 'perfect_1', icon: '‚ú®', name: 'Perfekte Woche', desc: '1 perfekte Woche', xp: 100, check: (stats) => stats.perfectWeeks >= 1 },
            { id: 'perfect_4', icon: 'üåà', name: 'Perfekter Monat', desc: '4 perfekte Wochen', xp: 300, check: (stats) => stats.perfectWeeks >= 4 },
            { id: 'perfect_12', icon: 'üí´', name: 'Perfektes Quartal', desc: '12 perfekte Wochen', xp: 750, check: (stats) => stats.perfectWeeks >= 12 },

            // Special Medals
            { id: 'early_bird', icon: 'üåÖ', name: 'Fr√ºher Vogel', desc: 'Ersten Eintrag gemacht', xp: 10, check: (stats) => stats.totalEntries >= 1 },
            { id: 'consistency', icon: 'üìä', name: 'Daten-Nerd', desc: '30 Tage geloggt', xp: 75, check: (stats) => stats.totalEntries >= 30 },
            { id: 'quarter_q1', icon: 'üéØ', name: 'Q1 Sieger', desc: 'Q1 Ziel erreicht', xp: 300, check: (stats) => stats.q1Reached },
            { id: 'quarter_q2', icon: '‚òÄÔ∏è', name: 'Q2 Sieger', desc: 'Q2 Ziel erreicht', xp: 300, check: (stats) => stats.q2Reached },
            { id: 'quarter_q3', icon: 'üçÇ', name: 'Q3 Sieger', desc: 'Q3 Ziel erreicht', xp: 300, check: (stats) => stats.q3Reached },
            { id: 'quarter_q4', icon: '‚ùÑÔ∏è', name: 'Q4 Sieger', desc: 'Q4 Ziel erreicht', xp: 500, check: (stats) => stats.q4Reached }
        ];

        // Daily Challenges (rotate based on day)
        const DAILY_CHALLENGES = [
            { id: 'train_today', icon: 'üí™', name: 'Training absolvieren', desc: 'Schlie√üe dein heutiges Training ab', xp: 20, check: (todayEntry) => todayEntry?.training },
            { id: 'protein_180', icon: 'ü•©', name: 'Protein-Ziel', desc: 'Erreiche 180g Protein', xp: 15, check: (todayEntry) => todayEntry?.protein >= 180 },
            { id: 'if_today', icon: '‚è∞', name: 'IF einhalten', desc: 'Halte das 12-20 Uhr Fenster ein', xp: 10, check: (todayEntry) => todayEntry?.if },
            { id: 'calorie_zone', icon: 'üéØ', name: 'Kalorien-Zone', desc: 'Bleib zwischen 2100-2400 kcal', xp: 15, check: (todayEntry) => todayEntry?.calories >= 2100 && todayEntry?.calories <= 2400 },
            { id: 'log_weight', icon: '‚öñÔ∏è', name: 'Wiegen', desc: 'Trage dein Gewicht ein', xp: 5, check: (todayEntry) => todayEntry?.weight }
        ];

        // Weekly Challenges (rotate based on week number)
        const WEEKLY_CHALLENGES = [
            { id: 'perfect_week', icon: 'üèÜ', name: 'Perfekte Woche', desc: '6/6 Trainings diese Woche', xp: 150, target: 6, getProgress: (stats) => stats.weekTrainings },
            { id: 'protein_week', icon: 'ü•©', name: 'Protein-Woche', desc: '5 Tage mit 180g+ Protein', xp: 100, target: 5, getProgress: (stats) => stats.weekProteinDays },
            { id: 'if_week', icon: '‚è∞', name: 'IF-Woche', desc: '6 Tage IF eingehalten', xp: 75, target: 6, getProgress: (stats) => stats.weekIFDays },
            { id: 'weight_down', icon: 'üìâ', name: 'Abw√§rtstrend', desc: 'Gewicht diese Woche reduzieren', xp: 100, target: 1, getProgress: (stats) => stats.weekWeightDown ? 1 : 0 }
        ];

        // XP rewards for actions
        const XP_REWARDS = {
            training: 25,
            proteinGoal: 10,
            ifDone: 5,
            calorieZone: 10,
            logWeight: 3,
            logEntry: 2
        };

        // ============ HELPER FUNCTIONS ============
        function getData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { entries: {}, startWeight: START_WEIGHT, bRotation: 0 };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(str) {
            return new Date(str + 'T00:00:00');
        }

        function getDayName(date) {
            return ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][date.getDay()];
        }

        // ============ WORKOUT CALCULATION ============
        function getTodayWorkout() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday

            // Saturday is always Cheat Day
            if (dayOfWeek === 6) {
                return 'CHEAT';
            }

            const data = getData();

            // Calculate days since start, excluding Saturdays
            // This ensures strict A-B-A-B rotation based on actual training days
            let dayCount = 0;
            const startDate = new Date(START_DATE);
            const currentDate = new Date(today);
            currentDate.setHours(0, 0, 0, 0);
            startDate.setHours(0, 0, 0, 0);

            for (let d = new Date(startDate); d <= currentDate; d.setDate(d.getDate() + 1)) {
                // Skip Saturdays (Cheat Days don't count in rotation)
                if (d.getDay() !== 6) {
                    dayCount++;
                }
            }

            // Odd days = A (Laufen), Even days = B (Kraft)
            // Day 1 = A, Day 2 = B, Day 3 = A, Day 4 = B, etc.
            const isADay = dayCount % 2 === 1;

            if (isADay) {
                return 'A';
            } else {
                // Determine which B workout based on rotation
                const bRotation = data.bRotation || 0;
                const bWorkouts = ['B1', 'B2', 'B3'];
                return bWorkouts[bRotation % 3];
            }
        }

        function advanceBRotation() {
            const data = getData();
            data.bRotation = ((data.bRotation || 0) + 1) % 3;
            saveData(data);
        }

        // Auto-refresh at midnight
        function scheduleMiddnightRefresh() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setDate(midnight.getDate() + 1);
            midnight.setHours(0, 0, 1, 0); // 00:00:01 next day

            const msUntilMidnight = midnight - now;

            setTimeout(() => {
                updateDashboard();
                updateHistory();
                initForm();
                scheduleMiddnightRefresh(); // Schedule next refresh
            }, msUntilMidnight);
        }

        // ============ STREAK CALCULATION ============
        function calculateStreak() {
            const data = getData();
            const entries = data.entries;
            const sortedDates = Object.keys(entries).sort().reverse();

            let streak = 0;
            let checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);

            // Check if today was already logged
            const todayStr = formatDate(checkDate);
            if (entries[todayStr]?.training) {
                streak = 1;
                checkDate.setDate(checkDate.getDate() - 1);
            }

            // Count backwards
            while (true) {
                const dateStr = formatDate(checkDate);
                const entry = entries[dateStr];

                // Skip Saturdays (Cheat Days)
                if (checkDate.getDay() === 6) {
                    checkDate.setDate(checkDate.getDate() - 1);
                    continue;
                }

                if (entry?.training) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (entry) {
                    // Entry exists but no training = streak broken
                    break;
                } else {
                    // No entry = assume streak continues only if within reasonable range
                    break;
                }
            }

            return streak;
        }

        // ============ NEVER MISS TWICE ============
        function checkNeverMissTwice() {
            const data = getData();
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Skip if yesterday was Saturday (Cheat Day)
            if (yesterday.getDay() === 6) return false;

            const yesterdayStr = formatDate(yesterday);
            const entry = data.entries[yesterdayStr];

            // Alert if yesterday had an entry but no training
            return entry && !entry.training;
        }

        // ============ STATS CALCULATION ============
        function getWeeklyAverage() {
            const data = getData();
            const entries = data.entries;
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);

            let weights = [];
            let calories = [];
            let proteins = [];
            let trainingCount = 0;

            for (let d = new Date(weekAgo); d <= today; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const entry = entries[dateStr];
                if (entry) {
                    if (entry.weight) weights.push(entry.weight);
                    if (entry.calories) calories.push(entry.calories);
                    if (entry.protein) proteins.push(entry.protein);
                    if (entry.training) trainingCount++;
                }
            }

            return {
                weight: weights.length ? (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1) : null,
                calories: calories.length ? Math.round(calories.reduce((a, b) => a + b, 0) / calories.length) : null,
                protein: proteins.length ? Math.round(proteins.reduce((a, b) => a + b, 0) / proteins.length) : null,
                trainingDays: trainingCount
            };
        }

        function getLatestWeight() {
            const data = getData();
            const entries = data.entries;
            const sortedDates = Object.keys(entries).sort().reverse();

            for (const date of sortedDates) {
                if (entries[date].weight) {
                    return entries[date].weight;
                }
            }
            return null;
        }

        function getMonthlyStats() {
            const data = getData();
            const entries = data.entries;
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            let firstWeight = null;
            let lastWeight = null;
            let trainingCount = 0;

            const sortedDates = Object.keys(entries).sort();

            for (const dateStr of sortedDates) {
                const date = parseDate(dateStr);
                if (date >= monthStart && date <= today) {
                    const entry = entries[dateStr];
                    if (entry.weight) {
                        if (!firstWeight) firstWeight = entry.weight;
                        lastWeight = entry.weight;
                    }
                    if (entry.training) trainingCount++;
                }
            }

            return {
                start: firstWeight,
                current: lastWeight,
                change: firstWeight && lastWeight ? (lastWeight - firstWeight).toFixed(1) : null,
                trainings: trainingCount
            };
        }

        // ============ GAMIFICATION FUNCTIONS ============

        function getGamificationData() {
            const data = getData();
            if (!data.gamification) {
                data.gamification = {
                    xp: 0,
                    unlockedMedals: {},
                    completedDailyChallenges: {},
                    completedWeeklyChallenges: {},
                    bestStreak: 0,
                    perfectWeeks: 0
                };
                saveData(data);
            }
            return data.gamification;
        }

        function saveGamificationData(gamData) {
            const data = getData();
            data.gamification = gamData;
            saveData(data);
        }

        function addXP(amount, reason) {
            const gamData = getGamificationData();
            const oldLevel = getCurrentLevel(gamData.xp);
            gamData.xp += amount;
            const newLevel = getCurrentLevel(gamData.xp);
            saveGamificationData(gamData);

            // Check for level up
            if (newLevel.level > oldLevel.level) {
                showReward('üéâ', `Level ${newLevel.level} erreicht!`, `${newLevel.title}`, amount);
            }

            updateXPDisplay();
            return gamData.xp;
        }

        function getCurrentLevel(xp) {
            let currentLevel = LEVELS[0];
            for (const level of LEVELS) {
                if (xp >= level.xpNeeded) {
                    currentLevel = level;
                } else {
                    break;
                }
            }
            return currentLevel;
        }

        function getNextLevel(xp) {
            for (const level of LEVELS) {
                if (xp < level.xpNeeded) {
                    return level;
                }
            }
            return null; // Max level reached
        }

        function calculateStats() {
            const data = getData();
            const entries = data.entries;
            const sortedDates = Object.keys(entries).sort();

            let stats = {
                totalTrainings: 0,
                totalEntries: sortedDates.length,
                weightLost: 0,
                currentWeight: null,
                bestStreak: 0,
                currentStreak: calculateStreak(),
                proteinStreak: 0,
                ifStreak: 0,
                perfectWeeks: 0,
                weekTrainings: 0,
                weekProteinDays: 0,
                weekIFDays: 0,
                weekWeightDown: false,
                q1Reached: false,
                q2Reached: false,
                q3Reached: false,
                q4Reached: false
            };

            // Calculate totals
            let currentProteinStreak = 0;
            let currentIFStreak = 0;
            let weekStart = getWeekStart(new Date());
            let firstWeekWeight = null;
            let lastWeekWeight = null;

            for (const dateStr of sortedDates) {
                const entry = entries[dateStr];
                const entryDate = parseDate(dateStr);

                if (entry.training) stats.totalTrainings++;
                if (entry.weight) stats.currentWeight = entry.weight;

                // Protein streak
                if (entry.protein >= 180) {
                    currentProteinStreak++;
                    stats.proteinStreak = Math.max(stats.proteinStreak, currentProteinStreak);
                } else {
                    currentProteinStreak = 0;
                }

                // IF streak
                if (entry.if) {
                    currentIFStreak++;
                    stats.ifStreak = Math.max(stats.ifStreak, currentIFStreak);
                } else {
                    currentIFStreak = 0;
                }

                // This week stats
                if (entryDate >= weekStart) {
                    if (entry.training) stats.weekTrainings++;
                    if (entry.protein >= 180) stats.weekProteinDays++;
                    if (entry.if) stats.weekIFDays++;
                    if (entry.weight) {
                        if (!firstWeekWeight) firstWeekWeight = entry.weight;
                        lastWeekWeight = entry.weight;
                    }
                }
            }

            // Weight loss
            if (stats.currentWeight) {
                stats.weightLost = START_WEIGHT - stats.currentWeight;
            }

            // Week weight down
            if (firstWeekWeight && lastWeekWeight && lastWeekWeight < firstWeekWeight) {
                stats.weekWeightDown = true;
            }

            // Best streak (use gamification data or current)
            const gamData = getGamificationData();
            stats.bestStreak = Math.max(gamData.bestStreak || 0, stats.currentStreak);

            // Update best streak if needed
            if (stats.currentStreak > (gamData.bestStreak || 0)) {
                gamData.bestStreak = stats.currentStreak;
                saveGamificationData(gamData);
            }

            // Perfect weeks
            stats.perfectWeeks = gamData.perfectWeeks || 0;

            // Quarter goals
            const today = new Date();
            if (stats.currentWeight) {
                if (today >= new Date('2026-03-31') && stats.currentWeight <= 99.5) stats.q1Reached = true;
                if (today >= new Date('2026-06-30') && stats.currentWeight <= 95.5) stats.q2Reached = true;
                if (today >= new Date('2026-09-30') && stats.currentWeight <= 92.5) stats.q3Reached = true;
                if (today >= new Date('2026-12-23') && stats.currentWeight <= 89.9) stats.q4Reached = true;
            }

            return stats;
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function checkAndUnlockMedals() {
            const stats = calculateStats();
            const gamData = getGamificationData();
            let newMedals = [];

            for (const medal of MEDALS) {
                if (!gamData.unlockedMedals[medal.id] && medal.check(stats)) {
                    gamData.unlockedMedals[medal.id] = {
                        unlockedAt: new Date().toISOString(),
                        xpAwarded: medal.xp
                    };
                    gamData.xp += medal.xp;
                    newMedals.push(medal);
                }
            }

            saveGamificationData(gamData);

            // Show unlock animation for new medals
            if (newMedals.length > 0) {
                showMedalUnlock(newMedals[0]);
            }

            return newMedals;
        }

        function showMedalUnlock(medal) {
            showReward(medal.icon, 'Neue Medaille!', medal.name, medal.xp);
        }

        function showReward(icon, title, subtitle, xp) {
            document.getElementById('rewardIcon').textContent = icon;
            document.getElementById('rewardTitle').textContent = title;
            document.getElementById('rewardXP').textContent = subtitle + (xp ? ` +${xp} XP` : '');
            document.getElementById('rewardOverlay').classList.add('show');
            document.getElementById('rewardModal').classList.add('show');
        }

        function closeRewardModal() {
            document.getElementById('rewardOverlay').classList.remove('show');
            document.getElementById('rewardModal').classList.remove('show');
            updateXPDisplay();
            updateAchievements();
        }

        function updateXPDisplay() {
            const gamData = getGamificationData();
            const currentLevel = getCurrentLevel(gamData.xp);
            const nextLevel = getNextLevel(gamData.xp);

            document.getElementById('levelIcon').textContent = currentLevel.level;
            document.getElementById('levelTitle').textContent = currentLevel.title;
            document.getElementById('totalXP').textContent = `${gamData.xp} XP gesamt`;

            if (nextLevel) {
                const xpInLevel = gamData.xp - currentLevel.xpNeeded;
                const xpForLevel = nextLevel.xpNeeded - currentLevel.xpNeeded;
                const progress = (xpInLevel / xpForLevel) * 100;
                document.getElementById('xpFill').style.width = `${progress}%`;
                document.getElementById('xpText').textContent = `${xpInLevel} / ${xpForLevel} XP zum Level ${nextLevel.level}`;
            } else {
                document.getElementById('xpFill').style.width = '100%';
                document.getElementById('xpText').textContent = 'MAX LEVEL erreicht!';
            }
        }

        function updateAchievements() {
            const gamData = getGamificationData();
            const stats = calculateStats();
            const data = getData();
            const todayEntry = data.entries[formatDate(new Date())] || {};

            // Update Daily Challenges
            const dailyContainer = document.getElementById('dailyChallenges');
            const today = formatDate(new Date());

            dailyContainer.innerHTML = DAILY_CHALLENGES.map(challenge => {
                const completed = challenge.check(todayEntry);
                const alreadyClaimed = gamData.completedDailyChallenges[today]?.[challenge.id];

                return `
                    <div class="challenge-card ${completed ? 'completed' : 'active'}">
                        <div class="challenge-header">
                            <div class="challenge-title">
                                <span class="icon">${challenge.icon}</span>
                                <span>${challenge.name}</span>
                            </div>
                            <span class="challenge-reward">${alreadyClaimed ? '‚úì' : `+${challenge.xp} XP`}</span>
                        </div>
                        <div class="challenge-status">${challenge.desc}</div>
                        <div class="challenge-progress">
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: ${completed ? 100 : 0}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update Weekly Challenge
            const weeklyContainer = document.getElementById('weeklyChallenges');
            const weekNum = getWeekNumber(new Date());
            const weeklyChallenge = WEEKLY_CHALLENGES[weekNum % WEEKLY_CHALLENGES.length];
            const weeklyProgress = weeklyChallenge.getProgress(stats);
            const weeklyCompleted = weeklyProgress >= weeklyChallenge.target;
            const weeklyKey = `${new Date().getFullYear()}-W${weekNum}`;
            const weeklyClaimed = gamData.completedWeeklyChallenges[weeklyKey]?.[weeklyChallenge.id];

            weeklyContainer.innerHTML = `
                <div class="challenge-card weekly-challenge ${weeklyCompleted ? 'completed' : 'active'}">
                    <div class="challenge-header">
                        <div class="challenge-title">
                            <span class="icon">${weeklyChallenge.icon}</span>
                            <span>${weeklyChallenge.name}</span>
                        </div>
                        <span class="challenge-reward">${weeklyClaimed ? '‚úì' : `+${weeklyChallenge.xp} XP`}</span>
                    </div>
                    <div class="challenge-status">${weeklyChallenge.desc}</div>
                    <div class="challenge-progress">
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${Math.min(100, (weeklyProgress / weeklyChallenge.target) * 100)}%"></div>
                        </div>
                        <div class="challenge-status">${weeklyProgress} / ${weeklyChallenge.target}</div>
                    </div>
                </div>
            `;

            // Update Medals Grid
            const medalsContainer = document.getElementById('medalsGrid');
            medalsContainer.innerHTML = MEDALS.map(medal => {
                const unlocked = gamData.unlockedMedals[medal.id];
                const unlockedDate = unlocked ? new Date(unlocked.unlockedAt).toLocaleDateString('de-DE') : '';

                return `
                    <div class="medal-item ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="medal-icon">${medal.icon}</div>
                        <div class="medal-name">${medal.name}</div>
                        <div class="medal-desc">${medal.desc}</div>
                        ${unlocked ? `<div class="medal-date">${unlockedDate}</div>` : ''}
                    </div>
                `;
            }).join('');

            // Update total stats
            document.getElementById('totalTrainings').textContent = stats.totalTrainings;
            document.getElementById('totalMedals').textContent = Object.keys(gamData.unlockedMedals).length;
            document.getElementById('bestStreak').textContent = stats.bestStreak;
        }

        function processDailyXP(entry, isNewEntry) {
            if (!isNewEntry) return;

            const gamData = getGamificationData();
            const today = formatDate(new Date());
            let xpEarned = 0;

            // Initialize daily challenges tracking for today
            if (!gamData.completedDailyChallenges[today]) {
                gamData.completedDailyChallenges[today] = {};
            }

            // Check each daily challenge
            for (const challenge of DAILY_CHALLENGES) {
                if (!gamData.completedDailyChallenges[today][challenge.id] && challenge.check(entry)) {
                    gamData.completedDailyChallenges[today][challenge.id] = true;
                    xpEarned += challenge.xp;
                }
            }

            // Check weekly challenge
            const weekNum = getWeekNumber(new Date());
            const weeklyKey = `${new Date().getFullYear()}-W${weekNum}`;
            const weeklyChallenge = WEEKLY_CHALLENGES[weekNum % WEEKLY_CHALLENGES.length];
            const stats = calculateStats();

            if (!gamData.completedWeeklyChallenges[weeklyKey]) {
                gamData.completedWeeklyChallenges[weeklyKey] = {};
            }

            if (!gamData.completedWeeklyChallenges[weeklyKey][weeklyChallenge.id]) {
                const progress = weeklyChallenge.getProgress(stats);
                if (progress >= weeklyChallenge.target) {
                    gamData.completedWeeklyChallenges[weeklyKey][weeklyChallenge.id] = true;
                    xpEarned += weeklyChallenge.xp;

                    // Track perfect weeks
                    if (weeklyChallenge.id === 'perfect_week') {
                        gamData.perfectWeeks = (gamData.perfectWeeks || 0) + 1;
                    }
                }
            }

            if (xpEarned > 0) {
                gamData.xp += xpEarned;
                saveGamificationData(gamData);
            }

            // Check for new medals
            checkAndUnlockMedals();

            updateXPDisplay();
            updateAchievements();
        }

        // ============ UI UPDATE FUNCTIONS ============
        function updateDashboard() {
            const data = getData();
            const latestWeight = getLatestWeight();
            const weeklyStats = getWeeklyAverage();
            const streak = calculateStreak();
            const todayWorkout = getTodayWorkout();

            // Progress
            if (latestWeight) {
                document.getElementById('currentWeight').textContent = `${latestWeight} kg`;
                const lost = (START_WEIGHT - latestWeight).toFixed(1);
                const toGo = (latestWeight - GOAL_WEIGHT).toFixed(1);
                const progress = ((START_WEIGHT - latestWeight) / (START_WEIGHT - GOAL_WEIGHT)) * 100;

                document.getElementById('weightLost').textContent = lost;
                document.getElementById('weightToGo').textContent = toGo;
                document.getElementById('progressFill').style.width = `${Math.min(100, Math.max(0, progress))}%`;
            }

            // Days left and current date display
            const today = new Date();
            const daysLeft = Math.ceil((GOAL_DATE - today) / (1000 * 60 * 60 * 24));
            document.getElementById('daysLeft').textContent = daysLeft;

            // Show current date in header
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('currentDate').textContent =
                `Heute: ${today.toLocaleDateString('de-DE', dateOptions)}`;

            // Weekly average
            document.getElementById('weeklyAvg').textContent = weeklyStats.weight ? `${weeklyStats.weight}` : '--';
            document.getElementById('avgCalories').textContent = weeklyStats.calories || '--';
            document.getElementById('avgProtein').textContent = weeklyStats.protein ? `${weeklyStats.protein}g` : '--';
            document.getElementById('trainingDays').textContent = `${weeklyStats.trainingDays}/7`;

            // Streak
            document.getElementById('streakCount').textContent = streak;

            // Today's workout
            const workout = WORKOUTS[todayWorkout];
            const badge = document.getElementById('todayBadge');
            badge.textContent = workout.name;
            badge.className = `training-badge ${workout.badge}`;
            document.getElementById('todayWorkout').innerHTML = `<p>${workout.details}</p>`;

            // Never miss twice alert
            const alertBanner = document.getElementById('alertBanner');
            if (checkNeverMissTwice()) {
                alertBanner.classList.add('show');
            } else {
                alertBanner.classList.remove('show');
            }

            // Quarter goals
            updateQuarterGoals(latestWeight);
        }

        function updateQuarterGoals(currentWeight) {
            const container = document.getElementById('quarterGoals');
            const today = new Date();

            container.innerHTML = QUARTER_GOALS.map(q => {
                let status = 'future';
                let icon = '‚è≥';

                if (today > q.date) {
                    status = currentWeight && currentWeight <= q.target ? 'achieved' : 'future';
                    icon = currentWeight && currentWeight <= q.target ? '‚úÖ' : '‚ùå';
                } else if (today <= q.date && (QUARTER_GOALS.indexOf(q) === 0 || today > QUARTER_GOALS[QUARTER_GOALS.indexOf(q) - 1]?.date)) {
                    status = 'current';
                    icon = 'üéØ';
                }

                return `
                    <div class="quarter-item ${status}">
                        <span>${icon} ${q.label}</span>
                        <span>${q.target} kg</span>
                    </div>
                `;
            }).join('');
        }

        function updateHistory() {
            const data = getData();
            const entries = data.entries;
            const container = document.getElementById('historyList');

            const sortedDates = Object.keys(entries).sort().reverse().slice(0, 14);

            if (sortedDates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">Noch keine Eintr√§ge</p>';
                return;
            }

            container.innerHTML = sortedDates.map(dateStr => {
                const entry = entries[dateStr];
                const date = parseDate(dateStr);

                return `
                    <div class="history-item">
                        <div class="history-date">
                            <strong>${getDayName(date)}</strong><br>
                            ${dateStr.slice(5)}
                        </div>
                        <div class="history-data">
                            ${entry.weight ? `<span class="history-tag">${entry.weight} kg</span>` : ''}
                            ${entry.training ? '<span class="history-tag success">‚úÖ Training</span>' : '<span class="history-tag warning">‚ùå Kein Training</span>'}
                            ${entry.calories ? `<span class="history-tag">${entry.calories} kcal</span>` : ''}
                            ${entry.protein ? `<span class="history-tag">${entry.protein}g Protein</span>` : ''}
                            ${entry.if ? '<span class="history-tag success">IF ‚úì</span>' : ''}
                            ${entry.cheat ? '<span class="history-tag" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">üçï Cheat</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Monthly stats
            const monthly = getMonthlyStats();
            document.getElementById('monthStart').textContent = monthly.start ? `${monthly.start} kg` : '--';
            document.getElementById('monthCurrent').textContent = monthly.current ? `${monthly.current} kg` : '--';
            document.getElementById('monthChange').textContent = monthly.change ? `${monthly.change} kg` : '--';
            document.getElementById('monthChange').className = `value ${parseFloat(monthly.change) < 0 ? 'trend-down' : 'trend-up'}`;
            document.getElementById('monthTrainings').textContent = monthly.trainings;
        }

        // ============ FORM HANDLING ============
        function initForm() {
            const dateInput = document.getElementById('entryDate');
            dateInput.value = formatDate(new Date());

            // Load existing entry for today
            loadEntryForDate(dateInput.value);

            dateInput.addEventListener('change', (e) => {
                loadEntryForDate(e.target.value);
            });
        }

        function loadEntryForDate(dateStr) {
            const data = getData();
            const entry = data.entries[dateStr] || {};

            document.getElementById('entryWeight').value = entry.weight || '';
            document.getElementById('entryCalories').value = entry.calories || '';
            document.getElementById('entryProtein').value = entry.protein || '';
            document.getElementById('trainingDone').checked = entry.training || false;
            document.getElementById('ifDone').checked = entry.if || false;
            document.getElementById('cheatDay').checked = entry.cheat || false;

            updateQuickStats(entry);
        }

        function updateQuickStats(entry) {
            const proteinEl = document.getElementById('proteinStatus');
            const calorieEl = document.getElementById('calorieStatus');

            if (entry.protein) {
                const proteinOk = entry.protein >= 180;
                proteinEl.textContent = `${entry.protein}g`;
                proteinEl.style.color = proteinOk ? 'var(--success)' : 'var(--warning)';
            } else {
                proteinEl.textContent = '--';
                proteinEl.style.color = '';
            }

            if (entry.calories) {
                const inRange = entry.calories >= 2100 && entry.calories <= 2400;
                calorieEl.textContent = entry.calories;
                calorieEl.style.color = inRange ? 'var(--success)' : 'var(--warning)';
            } else {
                calorieEl.textContent = '--';
                calorieEl.style.color = '';
            }
        }

        // ============ EVENT LISTENERS ============
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');

                    if (tab.dataset.tab === 'history') {
                        updateHistory();
                    }
                    if (tab.dataset.tab === 'achievements') {
                        updateAchievements();
                    }
                });
            });

            // Form submission
            document.getElementById('dailyForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const dateStr = document.getElementById('entryDate').value;
                const data = getData();

                const wasTrainingBefore = data.entries[dateStr]?.training;
                const isTrainingNow = document.getElementById('trainingDone').checked;

                const entry = {
                    weight: parseFloat(document.getElementById('entryWeight').value) || null,
                    calories: parseInt(document.getElementById('entryCalories').value) || null,
                    protein: parseInt(document.getElementById('entryProtein').value) || null,
                    training: isTrainingNow,
                    if: document.getElementById('ifDone').checked,
                    cheat: document.getElementById('cheatDay').checked
                };

                data.entries[dateStr] = entry;

                // Advance B rotation if this is a new B-day training
                if (!wasTrainingBefore && isTrainingNow) {
                    const todayWorkout = getTodayWorkout();
                    if (todayWorkout.startsWith('B')) {
                        advanceBRotation();
                    }
                }

                saveData(data);

                // Process gamification XP and check achievements
                const isNewEntry = !wasTrainingBefore ||
                    entry.protein !== data.entries[dateStr]?.protein ||
                    entry.if !== data.entries[dateStr]?.if;
                processDailyXP(entry, true);

                updateQuickStats(entry);
                updateDashboard();
                updateXPDisplay();

                // Visual feedback
                const btn = e.target.querySelector('button');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Gespeichert!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });

            // Initialize
            initForm();
            updateDashboard();
            updateXPDisplay();
            updateAchievements();
            scheduleMiddnightRefresh(); // Auto-update at midnight
        });
    </script>
</body>
</html>
