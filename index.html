<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playbook 2026 - Fitness Tracker</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            color: var(--light);
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        header .subtitle {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            animation: pulse 2s infinite;
        }

        .alert-banner.show {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .alert-banner h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .alert-banner p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Progress Section */
        .progress-container {
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-box .label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Today's Training */
        .training-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .training-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .training-badge.day-a {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .training-badge.day-b {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        }

        .training-badge.cheat {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .workout-details {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .workout-details h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .workout-details ul {
            list-style: none;
            padding-left: 0;
        }

        .workout-details li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .workout-details li:last-child {
            border-bottom: none;
        }

        /* Form */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .form-group input[type="number"],
        .form-group input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            flex: 1;
            min-width: 120px;
        }

        .checkbox-item input[type="checkbox"] {
            display: none;
        }

        .checkbox-item label {
            display: block;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .checkbox-item input:checked + label {
            background: rgba(22, 163, 74, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #1d4ed8);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #15803d);
            color: white;
        }

        /* History */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .history-data {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .history-tag.success {
            background: rgba(22, 163, 74, 0.2);
            color: var(--success);
        }

        .history-tag.warning {
            background: rgba(234, 88, 12, 0.2);
            color: var(--warning);
        }

        /* Streak */
        .streak-display {
            text-align: center;
            padding: 20px;
        }

        .streak-number {
            font-size: 4rem;
            font-weight: bold;
            background: linear-gradient(135deg, #f59e0b, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .streak-label {
            font-size: 1rem;
            color: var(--gray);
        }

        /* Weekly Average */
        .weekly-avg {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
        }

        .weekly-item {
            text-align: center;
        }

        .weekly-item .value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .weekly-item .label {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .trend-up { color: var(--danger); }
        .trend-down { color: var(--success); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--gray);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quarter Goals */
        .quarter-goals {
            display: grid;
            gap: 10px;
        }

        .quarter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .quarter-item.achieved {
            border-left: 3px solid var(--success);
        }

        .quarter-item.current {
            border-left: 3px solid var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .quarter-item.future {
            opacity: 0.6;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .checkbox-item {
                min-width: 100px;
            }
        }

        /* Workout Rotation Indicator */
        .rotation-indicator {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .rotation-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .rotation-dot.active {
            background: var(--primary);
        }

        .rotation-dot.b1 { background: #ef4444; }
        .rotation-dot.b2 { background: #3b82f6; }
        .rotation-dot.b3 { background: #22c55e; }

        /* ============ GAMIFICATION STYLES ============ */

        /* XP Bar */
        .xp-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .level-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .level-badge {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }

        .level-info h3 {
            font-size: 1.1rem;
            margin-bottom: 2px;
        }

        .level-info span {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .xp-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .xp-text {
            text-align: right;
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Medals Grid */
        .medals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .medal-item {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .medal-item.locked {
            opacity: 0.4;
            filter: grayscale(100%);
        }

        .medal-item.unlocked {
            border-color: #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
        }

        .medal-item.unlocked::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .medal-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .medal-name {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .medal-desc {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .medal-item.unlocked .medal-date {
            font-size: 0.65rem;
            color: #fbbf24;
            margin-top: 5px;
        }

        /* Challenges */
        .challenge-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .challenge-card.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }

        .challenge-card.completed {
            border-color: var(--success);
            background: rgba(22, 163, 74, 0.1);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .challenge-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .challenge-title .icon {
            font-size: 1.3rem;
        }

        .challenge-reward {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .challenge-progress {
            margin-top: 10px;
        }

        .challenge-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .challenge-card.completed .challenge-progress-fill {
            background: var(--success);
        }

        .challenge-status {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Weekly Challenge Special */
        .weekly-challenge {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(109, 40, 217, 0.2));
            border: 2px solid #8b5cf6;
        }

        .weekly-challenge .challenge-reward {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
        }

        /* Rewards Section */
        .reward-unlock {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 3px solid #fbbf24;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 1000;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .reward-unlock.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .reward-unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: none;
        }

        .reward-unlock-overlay.show {
            display: block;
        }

        .reward-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 0.5s ease infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        .reward-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 10px;
        }

        .reward-xp {
            font-size: 1.2rem;
            color: var(--success);
        }

        .reward-close {
            margin-top: 20px;
            padding: 10px 30px;
            background: #fbbf24;
            color: #1e293b;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Streak Milestones */
        .streak-milestones {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .milestone {
            text-align: center;
            opacity: 0.4;
        }

        .milestone.achieved {
            opacity: 1;
        }

        .milestone.next {
            opacity: 0.7;
            color: var(--primary);
        }

        .milestone-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .milestone-days {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Leaderboard / Stats */
        .total-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .total-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .total-stat .num {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
        }

        .total-stat .lbl {
            font-size: 0.7rem;
            color: var(--gray);
        }

        /* Tabs adjustment for more tabs */
        .tabs {
            flex-wrap: wrap;
        }

        .tab {
            font-size: 0.8rem;
            padding: 8px 5px;
        }

        @media (max-width: 600px) {
            .medals-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .tab {
                font-size: 0.75rem;
            }
        }

        /* ============ CHART STYLES ============ */
        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .chart-canvas {
            width: 100%;
            height: 250px;
            display: block;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .chart-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .chart-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .chart-stat .value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
        }

        .chart-stat .label {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 3px;
        }

        .chart-stat.positive .value { color: var(--success); }
        .chart-stat.negative .value { color: var(--danger); }

        .time-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .time-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--gray);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .time-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .projection-info {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
        }

        .projection-info h4 {
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .projection-info p {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* ============ SCIENTIFIC GOALS STYLES ============ */
        .scientific-goals {
            padding: 10px 0;
        }

        .bmi-display {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bmi-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .bmi-category {
            font-size: 1rem;
            margin-bottom: 15px;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }

        .bmi-category.normal { background: rgba(22, 163, 74, 0.2); color: var(--success); }
        .bmi-category.overweight { background: rgba(234, 88, 12, 0.2); color: var(--warning); }
        .bmi-category.obese { background: rgba(220, 38, 38, 0.2); color: var(--danger); }
        .bmi-category.underweight { background: rgba(59, 130, 246, 0.2); color: var(--primary); }

        .bmi-bar {
            position: relative;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }

        .bmi-zones {
            display: flex;
            height: 100%;
        }

        .bmi-zones .zone {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
        }

        .zone-under { background: #3b82f6; }
        .zone-normal { background: #22c55e; }
        .zone-over { background: #f59e0b; }
        .zone-obese1 { background: #ef4444; }
        .zone-obese2 { background: #991b1b; }

        .bmi-marker {
            position: absolute;
            top: -2px;
            width: 4px;
            height: 28px;
            background: white;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            transition: left 0.5s ease;
        }

        .goals-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .goal-icon {
            font-size: 1.5rem;
        }

        .goal-info {
            flex: 1;
        }

        .goal-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .goal-label {
            font-size: 0.7rem;
            color: var(--gray);
        }

        @media (max-width: 500px) {
            .goals-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============ SETTINGS STYLES ============ */
        .settings-grid {
            display: grid;
            gap: 20px;
        }

        .setting-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 12px;
        }

        .setting-item label {
            display: block;
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .gender-toggle {
            display: flex;
            gap: 10px;
        }

        .gender-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            color: var(--gray);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .gender-btn.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.2);
            color: white;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            -webkit-appearance: none;
            appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }

        .slider-value {
            min-width: 80px;
            text-align: right;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .activity-levels {
            display: grid;
            gap: 12px;
        }

        .activity-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
        }

        .activity-btn:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .activity-btn.active {
            border-color: var(--success);
            background: rgba(22, 163, 74, 0.15);
        }

        .activity-icon {
            font-size: 2rem;
            width: 50px;
            text-align: center;
        }

        .activity-info {
            flex: 1;
        }

        .activity-name {
            color: white;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .activity-desc {
            color: var(--gray);
            font-size: 0.8rem;
            margin-bottom: 6px;
        }

        .activity-stats {
            display: flex;
            gap: 15px;
        }

        .activity-stats span {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
        }

        .activity-btn.active .activity-stats span {
            background: rgba(22, 163, 74, 0.3);
            color: var(--success);
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .preview-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .preview-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .preview-item .label {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .formula-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .formula-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 10px;
        }

        .formula-item h4 {
            color: var(--primary);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .formula-item code {
            display: block;
            color: var(--gray);
            font-size: 0.75rem;
            font-family: monospace;
        }

        @media (max-width: 600px) {
            .preview-grid, .formula-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PLAYBOOK 2026</h1>
            <p class="subtitle">Ziel: 89,9 kg bis 23. Dezember 2026</p>
            <p class="subtitle" id="currentDate" style="margin-top: 5px; font-size: 0.85rem;"></p>
        </header>

        <!-- Never Miss Twice Alert -->
        <div class="alert-banner" id="alertBanner">
            <h3>‚ö†Ô∏è NEVER MISS TWICE!</h3>
            <p>Du hast gestern kein Training gemacht. Heute ist NICHT verhandelbar!</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="entry">Eintragen</button>
            <button class="tab" data-tab="charts">Grafik</button>
            <button class="tab" data-tab="achievements">Erfolge</button>
            <button class="tab" data-tab="history">Verlauf</button>
            <button class="tab" data-tab="workouts">Workouts</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è</button>
        </div>

        <!-- XP Bar (shows on all tabs) -->
        <div class="xp-container" id="xpContainer">
            <div class="level-display">
                <div class="level-badge">
                    <div class="level-icon" id="levelIcon">1</div>
                    <div class="level-info">
                        <h3 id="levelTitle">Anf√§nger</h3>
                        <span id="totalXP">0 XP gesamt</span>
                    </div>
                </div>
            </div>
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill" style="width: 0%"></div>
            </div>
            <div class="xp-text" id="xpText">0 / 100 XP zum n√§chsten Level</div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <!-- Progress Card -->
            <div class="card">
                <h2>üìä Fortschritt zum Ziel</h2>
                <div class="progress-container">
                    <div class="progress-header">
                        <span id="currentWeight">-- kg</span>
                        <span>Ziel: 89,9 kg</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="weightLost">--</div>
                        <div class="label">kg verloren</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="weightToGo">--</div>
                        <div class="label">kg noch</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="daysLeft">--</div>
                        <div class="label">Tage √ºbrig</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="weeklyAvg">--</div>
                        <div class="label">√ò 7 Tage</div>
                    </div>
                </div>
            </div>

            <!-- Scientific Goals Card -->
            <div class="card">
                <h2>üî¨ Wissenschaftliche Ziele</h2>
                <div class="scientific-goals">
                    <div class="bmi-display">
                        <div class="bmi-value" id="currentBMI">--</div>
                        <div class="bmi-category" id="bmiCategory">--</div>
                        <div class="bmi-bar">
                            <div class="bmi-zones">
                                <span class="zone zone-under">U</span>
                                <span class="zone zone-normal">N</span>
                                <span class="zone zone-over">√ú</span>
                                <span class="zone zone-obese1">A1</span>
                                <span class="zone zone-obese2">A2</span>
                            </div>
                            <div class="bmi-marker" id="bmiMarker"></div>
                        </div>
                    </div>
                    <div class="goals-grid">
                        <div class="goal-item">
                            <div class="goal-icon">ü•©</div>
                            <div class="goal-info">
                                <div class="goal-value" id="proteinGoal">--</div>
                                <div class="goal-label">Protein/Tag (1,5g/kg)</div>
                            </div>
                        </div>
                        <div class="goal-item">
                            <div class="goal-icon">üî•</div>
                            <div class="goal-info">
                                <div class="goal-value" id="calorieGoal">--</div>
                                <div class="goal-label">Kalorien (Defizit)</div>
                            </div>
                        </div>
                        <div class="goal-item">
                            <div class="goal-icon">üéØ</div>
                            <div class="goal-info">
                                <div class="goal-value" id="nextMilestone">--</div>
                                <div class="goal-label">N√§chstes Ziel</div>
                            </div>
                        </div>
                        <div class="goal-item">
                            <div class="goal-icon">‚öñÔ∏è</div>
                            <div class="goal-info">
                                <div class="goal-value" id="idealWeight">--</div>
                                <div class="goal-label">Idealgewicht (BMI 22)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Streak Card -->
            <div class="card">
                <h2>üî• Training Streak</h2>
                <div class="streak-display">
                    <div class="streak-number" id="streakCount">0</div>
                    <div class="streak-label">Tage in Folge trainiert</div>
                </div>
            </div>

            <!-- Today's Training -->
            <div class="card">
                <h2>üí™ Heute</h2>
                <div class="training-type">
                    <span class="training-badge" id="todayBadge">--</span>
                </div>
                <div class="workout-details" id="todayWorkout">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Weekly Overview -->
            <div class="card">
                <h2>üìà Diese Woche</h2>
                <div class="weekly-avg">
                    <div class="weekly-item">
                        <div class="value" id="avgCalories">--</div>
                        <div class="label">√ò Kalorien</div>
                    </div>
                    <div class="weekly-item">
                        <div class="value" id="avgProtein">--</div>
                        <div class="label">√ò Protein</div>
                    </div>
                    <div class="weekly-item">
                        <div class="value" id="trainingDays">-/7</div>
                        <div class="label">Trainingstage</div>
                    </div>
                </div>
            </div>

            <!-- Quarter Goals -->
            <div class="card">
                <h2>üéØ Quartalsziele</h2>
                <div class="quarter-goals" id="quarterGoals">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Entry Tab -->
        <div class="tab-content" id="entry">
            <div class="card">
                <h2>üìù Tageseintrag</h2>
                <form id="dailyForm">
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label>Kalorien</label>
                        <input type="number" id="entryCalories" min="0" max="10000" placeholder="z.B. 2300">
                    </div>
                    <div class="form-group">
                        <label>Protein (g)</label>
                        <input type="number" id="entryProtein" min="0" max="500" placeholder="z.B. 180">
                    </div>
                    <div class="form-group">
                        <label>Checkboxen</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="trainingDone">
                                <label for="trainingDone">‚úÖ Training</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="ifDone">
                                <label for="ifDone">‚è∞ IF 12-20</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cheatDay">
                                <label for="cheatDay">üçï Cheat Day</label>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">üíæ Speichern</button>
                </form>
            </div>

            <!-- Quick Stats After Entry -->
            <div class="card">
                <h2>‚ö° Schnell-Check</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="proteinStatus">--</div>
                        <div class="label">Protein heute</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="calorieStatus">--</div>
                        <div class="label">Kalorien heute</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Tab -->
        <div class="tab-content" id="charts">
            <!-- Weight Entry Form -->
            <div class="card">
                <h2>‚öñÔ∏è Gewicht eintragen</h2>
                <form id="weightForm" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                        <label>Datum</label>
                        <input type="date" id="weightDate" required>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                        <label>Gewicht (kg)</label>
                        <input type="number" id="weightValue" step="0.1" min="50" max="200" placeholder="z.B. 103.5" required>
                    </div>
                    <button type="submit" class="btn btn-success" style="flex: 0 0 auto; padding: 12px 24px;">üíæ Speichern</button>
                </form>
                <p style="font-size: 0.8rem; color: var(--gray); margin-top: 10px;">üí° Tipp: Wiege dich jeden Donnerstag zur gleichen Zeit</p>
            </div>

            <div class="card">
                <h2>üìà Gewichtsverlauf</h2>
                <div class="time-filter">
                    <button class="time-btn active" data-days="7">7 Tage</button>
                    <button class="time-btn" data-days="14">14 Tage</button>
                    <button class="time-btn" data-days="30">30 Tage</button>
                    <button class="time-btn" data-days="90">3 Monate</button>
                    <button class="time-btn" data-days="365">1 Jahr</button>
                    <button class="time-btn" data-days="0">Alles</button>
                </div>
                <div class="chart-container">
                    <canvas id="weightChart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3b82f6;"></div>
                        <span>Gewicht</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #22c55e;"></div>
                        <span>7-Tage Durchschnitt</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f59e0b; opacity: 0.5;"></div>
                        <span>Ziel (89.9 kg)</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìä Statistiken</h2>
                <div class="chart-stats" id="chartStats">
                    <div class="chart-stat">
                        <div class="value" id="chartHighest">--</div>
                        <div class="label">H√∂chstes</div>
                    </div>
                    <div class="chart-stat">
                        <div class="value" id="chartLowest">--</div>
                        <div class="label">Niedrigstes</div>
                    </div>
                    <div class="chart-stat">
                        <div class="value" id="chartAverage">--</div>
                        <div class="label">Durchschnitt</div>
                    </div>
                    <div class="chart-stat" id="chartChangeBox">
                        <div class="value" id="chartChange">--</div>
                        <div class="label">Ver√§nderung</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üéØ Prognose</h2>
                <div class="projection-info">
                    <h4 id="projectionTitle">Berechne...</h4>
                    <p id="projectionText">Basierend auf deinem bisherigen Fortschritt</p>
                </div>
                <div class="chart-stats" style="margin-top: 15px;">
                    <div class="chart-stat">
                        <div class="value" id="weeklyLoss">--</div>
                        <div class="label">√ò pro Woche</div>
                    </div>
                    <div class="chart-stat">
                        <div class="value" id="daysToGoal">--</div>
                        <div class="label">Tage bis Ziel</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div class="tab-content" id="achievements">
            <!-- Daily Challenges -->
            <div class="card">
                <h2>‚ö° T√§gliche Herausforderungen</h2>
                <div id="dailyChallenges">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Weekly Challenge -->
            <div class="card">
                <h2>üèÜ Wochenherausforderung</h2>
                <div id="weeklyChallenges">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Medals -->
            <div class="card">
                <h2>üèÖ Medaillen</h2>
                <div class="medals-grid" id="medalsGrid">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Total Stats -->
            <div class="card">
                <h2>üìä Gesamt-Statistiken</h2>
                <div class="total-stats">
                    <div class="total-stat">
                        <div class="num" id="totalTrainings">0</div>
                        <div class="lbl">Trainings</div>
                    </div>
                    <div class="total-stat">
                        <div class="num" id="totalMedals">0</div>
                        <div class="lbl">Medaillen</div>
                    </div>
                    <div class="total-stat">
                        <div class="num" id="bestStreak">0</div>
                        <div class="lbl">Bester Streak</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="history">
            <div class="card">
                <h2>üìÖ Letzte 14 Tage</h2>
                <div class="history-list" id="historyList">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Monthly Stats -->
            <div class="card">
                <h2>üìä Monats√ºbersicht</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="monthStart">--</div>
                        <div class="label">Monatsstart</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="monthCurrent">--</div>
                        <div class="label">Aktuell</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="monthChange">--</div>
                        <div class="label">Ver√§nderung</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="monthTrainings">--</div>
                        <div class="label">Trainings</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workouts Tab -->
        <div class="tab-content" id="workouts">
            <div class="card">
                <h2 style="color: #3b82f6;">üèÉ Tag A: Laufen</h2>
                <div class="workout-details">
                    <p><strong>Phase 1 (Jan W1-4):</strong> 15-30 Min locker</p>
                    <p><strong>Phase 2 (Feb-M√§rz):</strong> 30-45 Min, Intervalle</p>
                    <p><strong>Phase 3 (Apr-Okt):</strong> 40-60 Min Mix</p>
                    <p><strong>Phase 4 (Nov-Dez):</strong> Wintermodus</p>
                    <h4 style="margin-top: 15px;">Indoor-Backup:</h4>
                    <ul>
                        <li>Boxsack: 20-30 Min Intervalle</li>
                        <li>HIIT Bodyweight: 20-25 Min</li>
                        <li>Springseil: 15-20 Min</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2 style="color: #ef4444;">üí™ B1: Push (Brust, Schultern, Trizeps)</h2>
                <div class="workout-details">
                    <ul>
                        <li>KH-Bankdr√ºcken (Boden): 4x8-12</li>
                        <li>KH-Schulterdr√ºcken: 3x10-12</li>
                        <li>KH-Flys: 3x12-15</li>
                        <li>Liegest√ºtze: 3x max</li>
                        <li>KH-Trizepsdr√ºcken: 3x12</li>
                        <li>Dips: 3x max</li>
                        <li>Finisher: Boxsack 3x2 Min</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2 style="color: #3b82f6;">üí™ B2: Pull (R√ºcken, Bizeps)</h2>
                <div class="workout-details">
                    <ul>
                        <li>Klimmz√ºge: 4x max</li>
                        <li>KH-Rudern einarmig: 4x10-12</li>
                        <li>KH-Kreuzheben: 3x10-12</li>
                        <li>Face Pulls: 3x15</li>
                        <li>KH-Curls: 3x12</li>
                        <li>Hammer Curls: 3x12</li>
                        <li>Shrugs: 3x15</li>
                        <li>Finisher: Plank 3x45-60s</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2 style="color: #22c55e;">üí™ B3: Legs + Core</h2>
                <div class="workout-details">
                    <ul>
                        <li>Goblet Squats: 4x12-15</li>
                        <li>KH-Ausfallschritte: 3x10/Bein</li>
                        <li>Rum√§nisches Kreuzheben: 4x10-12</li>
                        <li>Bulgarian Split Squats: 3x10/Bein</li>
                        <li>Wadenheben: 3x20</li>
                        <li>Russian Twists: 3x20</li>
                        <li>Dead Bugs: 3x12</li>
                        <li>Finisher: Boxsack Kicks 3x2 Min</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>üçΩÔ∏è Ern√§hrung Reminder</h2>
                <div class="workout-details">
                    <p><strong>IF-Fenster:</strong> 12:00 - 20:00 Uhr</p>
                    <p><strong>Kalorien:</strong> 2.100-2.400 kcal</p>
                    <p><strong>Protein:</strong> 180g minimum</p>
                    <p><strong>Cheat Day:</strong> Nur Samstag!</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="settings">
            <div class="card">
                <h2>‚öôÔ∏è Pers√∂nliche Einstellungen</h2>
                <p style="color: var(--gray); margin-bottom: 20px;">Diese Daten werden f√ºr die Berechnung deiner wissenschaftlichen Ziele verwendet.</p>

                <div class="settings-grid">
                    <div class="setting-item">
                        <label>Geschlecht</label>
                        <div class="gender-toggle">
                            <button type="button" class="gender-btn active" data-gender="male">‚ôÇ M√§nnlich</button>
                            <button type="button" class="gender-btn" data-gender="female">‚ôÄ Weiblich</button>
                        </div>
                    </div>

                    <div class="setting-item">
                        <label>K√∂rpergr√∂√üe</label>
                        <div class="slider-container">
                            <input type="range" id="settingHeight" min="150" max="210" value="183">
                            <span class="slider-value" id="heightValue">183 cm</span>
                        </div>
                    </div>

                    <div class="setting-item">
                        <label>Alter</label>
                        <div class="slider-container">
                            <input type="range" id="settingAge" min="16" max="80" value="26">
                            <span class="slider-value" id="ageValue">26 Jahre</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üèÉ Aktivit√§tslevel</h2>
                <p style="color: var(--gray); margin-bottom: 20px;">W√§hle dein Aktivit√§tslevel f√ºr angepasste Protein- und Kalorienziele.</p>

                <div class="activity-levels">
                    <button class="activity-btn" data-activity="sedentary">
                        <div class="activity-icon">ü™ë</div>
                        <div class="activity-info">
                            <div class="activity-name">Wenig aktiv</div>
                            <div class="activity-desc">Sitzende T√§tigkeit, kein Sport</div>
                            <div class="activity-stats">
                                <span>PAL: 1.2</span>
                                <span>Protein: 1.0g/kg</span>
                            </div>
                        </div>
                    </button>

                    <button class="activity-btn active" data-activity="moderate">
                        <div class="activity-icon">üö∂</div>
                        <div class="activity-info">
                            <div class="activity-name">Moderat aktiv</div>
                            <div class="activity-desc">Leichte Aktivit√§t, 2-3x Sport/Woche</div>
                            <div class="activity-stats">
                                <span>PAL: 1.5</span>
                                <span>Protein: 1.5g/kg</span>
                            </div>
                        </div>
                    </button>

                    <button class="activity-btn" data-activity="active">
                        <div class="activity-icon">üèÉ</div>
                        <div class="activity-info">
                            <div class="activity-name">Sehr aktiv</div>
                            <div class="activity-desc">Aktiver Job, 4-5x Sport/Woche</div>
                            <div class="activity-stats">
                                <span>PAL: 1.8</span>
                                <span>Protein: 1.8g/kg</span>
                            </div>
                        </div>
                    </button>

                    <button class="activity-btn" data-activity="athletic">
                        <div class="activity-icon">üí™</div>
                        <div class="activity-info">
                            <div class="activity-name">Athletisch</div>
                            <div class="activity-desc">Intensives Training, t√§glich</div>
                            <div class="activity-stats">
                                <span>PAL: 2.2</span>
                                <span>Protein: 2.2g/kg</span>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <div class="card">
                <h2>üìä Aktuelle Werte (Vorschau)</h2>
                <div class="preview-grid" id="settingsPreview">
                    <!-- Wird per JS gef√ºllt -->
                </div>
            </div>

            <div class="card">
                <h2>üìê Verwendete Formeln</h2>
                <div class="formula-grid">
                    <div class="formula-item">
                        <h4>BMI</h4>
                        <code>Gewicht / (Gr√∂√üe in m)¬≤</code>
                    </div>
                    <div class="formula-item">
                        <h4>Grundumsatz (Mifflin-St. Jeor)</h4>
                        <code>‚ôÇ: 10√ókg + 6.25√ócm - 5√óAlter + 5</code>
                        <code>‚ôÄ: 10√ókg + 6.25√ócm - 5√óAlter - 161</code>
                    </div>
                    <div class="formula-item">
                        <h4>Tagesbedarf (TDEE)</h4>
                        <code>Grundumsatz √ó PAL-Faktor</code>
                    </div>
                    <div class="formula-item">
                        <h4>Protein</h4>
                        <code>Gewicht √ó Aktivit√§tsfaktor</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reward Unlock Modal -->
    <div class="reward-unlock-overlay" id="rewardOverlay"></div>
    <div class="reward-unlock" id="rewardModal">
        <div class="reward-icon" id="rewardIcon">üèÜ</div>
        <div class="reward-title" id="rewardTitle">Neue Medaille!</div>
        <div class="reward-xp" id="rewardXP">+50 XP</div>
        <button class="reward-close" onclick="closeRewardModal()">Weiter</button>
    </div>

    <script>
        // ============ DATA STORAGE ============
        const STORAGE_KEY = 'playbook2026';
        const SETTINGS_KEY = 'playbook2026_settings';
        const START_WEIGHT = 109;
        const GOAL_WEIGHT = 89.9;
        const GOAL_DATE = new Date('2026-12-23');

        // ============ AKTIVIT√ÑTSLEVEL ============
        const ACTIVITY_LEVELS = {
            sedentary: { key: 'sedentary', label: 'Wenig aktiv', pal: 1.2, proteinFactor: 1.0 },
            moderate: { key: 'moderate', label: 'Moderat aktiv', pal: 1.5, proteinFactor: 1.5 },
            active: { key: 'active', label: 'Sehr aktiv', pal: 1.8, proteinFactor: 1.8 },
            athletic: { key: 'athletic', label: 'Athletisch', pal: 2.2, proteinFactor: 2.2 }
        };

        // ============ USER SETTINGS ============
        const DEFAULT_SETTINGS = {
            height: 183,      // cm
            age: 26,
            gender: 'male',
            activity: 'moderate'
        };

        function getUserSettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
            }
            return { ...DEFAULT_SETTINGS };
        }

        function saveUserSettings(settings) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            // Aktualisiere alle Anzeigen
            updateDashboard();
            updateScientificGoals();
            updateSettingsPreview();
        }

        function getActivityLevel() {
            const settings = getUserSettings();
            return ACTIVITY_LEVELS[settings.activity] || ACTIVITY_LEVELS.moderate;
        }

        function getUserHeightM() {
            return getUserSettings().height / 100;
        }

        // ============ SCIENTIFIC CALCULATIONS ============
        /**
         * Berechnet wissenschaftliche Ziele basierend auf aktuellem Gewicht
         * @param {number} weight - Aktuelles Gewicht in kg
         * @returns {Object} Wissenschaftliche Zielwerte
         */
        function calculateScientificGoals(weight) {
            if (!weight) return null;

            const settings = getUserSettings();
            const heightM = settings.height / 100;
            const activity = ACTIVITY_LEVELS[settings.activity] || ACTIVITY_LEVELS.moderate;

            // BMI Berechnung: Gewicht / (Gr√∂√üe¬≤)
            const bmi = weight / (heightM * heightM);

            // BMI Kategorie nach WHO
            let category, categoryClass;
            if (bmi < 18.5) {
                category = 'Untergewicht';
                categoryClass = 'underweight';
            } else if (bmi < 25) {
                category = 'Normalgewicht';
                categoryClass = 'normal';
            } else if (bmi < 30) {
                category = '√úbergewicht';
                categoryClass = 'overweight';
            } else if (bmi < 35) {
                category = 'Adipositas Grad I';
                categoryClass = 'obese';
            } else if (bmi < 40) {
                category = 'Adipositas Grad II';
                categoryClass = 'obese';
            } else {
                category = 'Adipositas Grad III';
                categoryClass = 'obese';
            }

            // Protein: basierend auf Aktivit√§tslevel
            const proteinGoal = Math.round(weight * activity.proteinFactor);

            // Kalorien: Grundumsatz nach Mifflin-St Jeor + Aktivit√§t - Defizit
            const genderOffset = settings.gender === 'male' ? 5 : -161;
            const bmr = 10 * weight + 6.25 * settings.height - 5 * settings.age + genderOffset;
            const tdee = bmr * activity.pal;
            const calorieGoal = Math.round(tdee - 500); // 500 kcal Defizit

            // Idealgewicht bei BMI 22
            const idealWeight = Math.round(22 * heightM * heightM * 10) / 10;

            // N√§chstes Meilenstein-Gewicht (5kg Schritte)
            const nextMilestone = Math.floor(weight / 5) * 5;

            // BMI-Marker Position (f√ºr Visualisierung)
            // BMI Range: 15-40 mapped to 0-100%
            const bmiPosition = Math.max(0, Math.min(100, ((bmi - 15) / 25) * 100));

            return {
                bmi: bmi.toFixed(1),
                category,
                categoryClass,
                proteinGoal,
                calorieGoal,
                idealWeight,
                nextMilestone: nextMilestone < weight ? nextMilestone : weight - 2,
                bmiPosition
            };
        }

        /**
         * Aktualisiert die Anzeige der wissenschaftlichen Ziele
         */
        function updateScientificGoals() {
            const latestWeight = getLatestWeight();
            const goals = calculateScientificGoals(latestWeight);

            if (!goals) {
                document.getElementById('currentBMI').textContent = '--';
                document.getElementById('bmiCategory').textContent = 'Gewicht eintragen';
                document.getElementById('bmiCategory').className = 'bmi-category';
                document.getElementById('proteinGoal').textContent = '--';
                document.getElementById('calorieGoal').textContent = '--';
                document.getElementById('nextMilestone').textContent = '--';
                document.getElementById('idealWeight').textContent = '--';
                return;
            }

            document.getElementById('currentBMI').textContent = `BMI ${goals.bmi}`;
            document.getElementById('bmiCategory').textContent = goals.category;
            document.getElementById('bmiCategory').className = `bmi-category ${goals.categoryClass}`;
            document.getElementById('proteinGoal').textContent = `${goals.proteinGoal}g`;
            document.getElementById('calorieGoal').textContent = `${goals.calorieGoal} kcal`;
            document.getElementById('nextMilestone').textContent = `${goals.nextMilestone} kg`;
            document.getElementById('idealWeight').textContent = `${goals.idealWeight} kg`;
            document.getElementById('bmiMarker').style.left = `${goals.bmiPosition}%`;
        }

        /**
         * Gibt das dynamische Proteinziel zur√ºck
         * @returns {number} Proteinziel in Gramm
         */
        function getDynamicProteinGoal() {
            const weight = getLatestWeight();
            const activity = getActivityLevel();
            return weight ? Math.round(weight * activity.proteinFactor) : 180; // Fallback auf 180g
        }

        // Start date: use first entry date or Jan 1, 2026 (whichever applies)
        function getStartDate() {
            const data = getData();
            const entries = Object.keys(data.entries).sort();
            if (entries.length > 0) {
                const firstEntry = new Date(entries[0] + 'T00:00:00');
                const jan2026 = new Date('2026-01-01');
                return firstEntry < jan2026 ? firstEntry : jan2026;
            }
            // If no entries yet, use today or Jan 2026
            const today = new Date();
            const jan2026 = new Date('2026-01-01');
            return today < jan2026 ? today : jan2026;
        }
        const START_DATE = new Date('2026-01-01'); // Fallback for rotation calc

        // Quarter Goals
        const QUARTER_GOALS = [
            { label: 'Q1 (31. M√§rz)', target: 99.5, date: new Date('2026-03-31') },
            { label: 'Q2 (30. Juni)', target: 95.5, date: new Date('2026-06-30') },
            { label: 'Q3 (30. Sept)', target: 92.5, date: new Date('2026-09-30') },
            { label: 'Q4 (23. Dez)', target: 89.9, date: new Date('2026-12-23') }
        ];

        // Workout rotation
        const WORKOUTS = {
            A: {
                name: 'Tag A: Laufen',
                badge: 'day-a',
                details: 'Ausdauertraining - Laufen oder Indoor-Alternative'
            },
            B1: {
                name: 'B1: Push',
                badge: 'day-b',
                details: 'Brust, Schultern, Trizeps + Boxsack Finisher'
            },
            B2: {
                name: 'B2: Pull',
                badge: 'day-b',
                details: 'R√ºcken, Bizeps + Plank Finisher'
            },
            B3: {
                name: 'B3: Legs + Core',
                badge: 'day-b',
                details: 'Beine, Ges√§√ü, Rumpf + Boxsack Kicks'
            },
            CHEAT: {
                name: 'Cheat Day',
                badge: 'cheat',
                details: 'Ruhetag - Training optional, Ern√§hrung frei'
            }
        };

        // ============ GAMIFICATION SYSTEM ============

        // Level titles and XP requirements
        const LEVELS = [
            { level: 1, title: 'Anf√§nger', xpNeeded: 0 },
            { level: 2, title: 'Rookie', xpNeeded: 100 },
            { level: 3, title: 'Aufsteiger', xpNeeded: 250 },
            { level: 4, title: 'K√§mpfer', xpNeeded: 500 },
            { level: 5, title: 'Athlet', xpNeeded: 800 },
            { level: 6, title: 'Krieger', xpNeeded: 1200 },
            { level: 7, title: 'Champion', xpNeeded: 1700 },
            { level: 8, title: 'Elite', xpNeeded: 2300 },
            { level: 9, title: 'Meister', xpNeeded: 3000 },
            { level: 10, title: 'Legende', xpNeeded: 4000 },
            { level: 11, title: 'Unstoppable', xpNeeded: 5500 },
            { level: 12, title: 'Titan', xpNeeded: 7500 },
            { level: 13, title: 'Gott-Modus', xpNeeded: 10000 }
        ];

        // Medal definitions
        const MEDALS = [
            // Streak Medals
            { id: 'streak_7', icon: 'üî•', name: '7-Tage-Feuer', desc: '7 Tage Streak', xp: 50, check: (stats) => stats.bestStreak >= 7 },
            { id: 'streak_14', icon: 'üí™', name: '2-Wochen-Warrior', desc: '14 Tage Streak', xp: 100, check: (stats) => stats.bestStreak >= 14 },
            { id: 'streak_30', icon: '‚ö°', name: 'Monats-Monster', desc: '30 Tage Streak', xp: 200, check: (stats) => stats.bestStreak >= 30 },
            { id: 'streak_60', icon: 'üèÜ', name: 'Unaufhaltsam', desc: '60 Tage Streak', xp: 400, check: (stats) => stats.bestStreak >= 60 },
            { id: 'streak_100', icon: 'üëë', name: 'Hundert-Tage-K√∂nig', desc: '100 Tage Streak', xp: 750, check: (stats) => stats.bestStreak >= 100 },

            // Training Medals
            { id: 'train_10', icon: 'üéØ', name: 'Erster Meilenstein', desc: '10 Trainings', xp: 30, check: (stats) => stats.totalTrainings >= 10 },
            { id: 'train_25', icon: 'üíé', name: 'Diamant-Disziplin', desc: '25 Trainings', xp: 60, check: (stats) => stats.totalTrainings >= 25 },
            { id: 'train_50', icon: 'üåü', name: 'Halb-Hundert', desc: '50 Trainings', xp: 120, check: (stats) => stats.totalTrainings >= 50 },
            { id: 'train_100', icon: 'üíØ', name: 'Centurion', desc: '100 Trainings', xp: 250, check: (stats) => stats.totalTrainings >= 100 },
            { id: 'train_200', icon: 'ü¶Å', name: 'L√∂wenherz', desc: '200 Trainings', xp: 500, check: (stats) => stats.totalTrainings >= 200 },

            // Weight Loss Medals
            { id: 'weight_5', icon: 'üìâ', name: 'Erste Erfolge', desc: '5 kg verloren', xp: 100, check: (stats) => stats.weightLost >= 5 },
            { id: 'weight_10', icon: 'üéâ', name: 'Zweistellig', desc: '10 kg verloren', xp: 250, check: (stats) => stats.weightLost >= 10 },
            { id: 'weight_15', icon: 'üöÄ', name: 'Transformation', desc: '15 kg verloren', xp: 500, check: (stats) => stats.weightLost >= 15 },
            { id: 'weight_goal', icon: 'üèÅ', name: 'Ziel erreicht!', desc: 'Unter 90 kg', xp: 1000, check: (stats) => stats.currentWeight && stats.currentWeight < 90 },

            // Protein Medals
            { id: 'protein_7', icon: 'ü•©', name: 'Protein-Pro', desc: '7 Tage Protein-Ziel erreicht', xp: 75, check: (stats) => stats.proteinStreak >= 7 },
            { id: 'protein_30', icon: 'üçó', name: 'Protein-Meister', desc: '30 Tage Protein-Ziel erreicht', xp: 200, check: (stats) => stats.proteinStreak >= 30 },

            // IF Medals
            { id: 'if_14', icon: '‚è∞', name: 'IF-Anf√§nger', desc: '14 Tage IF eingehalten', xp: 50, check: (stats) => stats.ifStreak >= 14 },
            { id: 'if_30', icon: 'üïê', name: 'IF-Profi', desc: '30 Tage IF eingehalten', xp: 100, check: (stats) => stats.ifStreak >= 30 },
            { id: 'if_60', icon: '‚åõ', name: 'IF-Meister', desc: '60 Tage IF eingehalten', xp: 200, check: (stats) => stats.ifStreak >= 60 },

            // Perfect Week Medals
            { id: 'perfect_1', icon: '‚ú®', name: 'Perfekte Woche', desc: '1 perfekte Woche', xp: 100, check: (stats) => stats.perfectWeeks >= 1 },
            { id: 'perfect_4', icon: 'üåà', name: 'Perfekter Monat', desc: '4 perfekte Wochen', xp: 300, check: (stats) => stats.perfectWeeks >= 4 },
            { id: 'perfect_12', icon: 'üí´', name: 'Perfektes Quartal', desc: '12 perfekte Wochen', xp: 750, check: (stats) => stats.perfectWeeks >= 12 },

            // Special Medals
            { id: 'early_bird', icon: 'üåÖ', name: 'Fr√ºher Vogel', desc: 'Ersten Eintrag gemacht', xp: 10, check: (stats) => stats.totalEntries >= 1 },
            { id: 'consistency', icon: 'üìä', name: 'Daten-Nerd', desc: '30 Tage geloggt', xp: 75, check: (stats) => stats.totalEntries >= 30 },
            { id: 'quarter_q1', icon: 'üéØ', name: 'Q1 Sieger', desc: 'Q1 Ziel erreicht', xp: 300, check: (stats) => stats.q1Reached },
            { id: 'quarter_q2', icon: '‚òÄÔ∏è', name: 'Q2 Sieger', desc: 'Q2 Ziel erreicht', xp: 300, check: (stats) => stats.q2Reached },
            { id: 'quarter_q3', icon: 'üçÇ', name: 'Q3 Sieger', desc: 'Q3 Ziel erreicht', xp: 300, check: (stats) => stats.q3Reached },
            { id: 'quarter_q4', icon: '‚ùÑÔ∏è', name: 'Q4 Sieger', desc: 'Q4 Ziel erreicht', xp: 500, check: (stats) => stats.q4Reached }
        ];

        // Daily Challenges (rotate based on day) - mit dynamischen Zielen
        const DAILY_CHALLENGES = [
            { id: 'train_today', icon: 'üí™', name: 'Training absolvieren', desc: 'Schlie√üe dein heutiges Training ab', xp: 20, check: (todayEntry) => todayEntry?.training },
            { id: 'protein_dynamic', icon: 'ü•©', name: 'Protein-Ziel', getDesc: () => `Erreiche ${getDynamicProteinGoal()}g Protein`, xp: 15, check: (todayEntry) => todayEntry?.protein >= getDynamicProteinGoal() },
            { id: 'if_today', icon: '‚è∞', name: 'IF einhalten', desc: 'Halte das 12-20 Uhr Fenster ein', xp: 10, check: (todayEntry) => todayEntry?.if },
            { id: 'calorie_dynamic', icon: 'üéØ', name: 'Kalorien-Zone', getDesc: () => { const g = calculateScientificGoals(getLatestWeight()); return g ? `Bleib bei ~${g.calorieGoal} kcal` : 'Kalorien im Defizit'; }, xp: 15, check: (todayEntry) => { const g = calculateScientificGoals(getLatestWeight()); return g && todayEntry?.calories >= (g.calorieGoal - 200) && todayEntry?.calories <= (g.calorieGoal + 200); } },
            { id: 'log_weight', icon: '‚öñÔ∏è', name: 'Wiegen', desc: 'Trage dein Gewicht ein', xp: 5, check: (todayEntry) => todayEntry?.weight }
        ];

        // Weekly Challenges (rotate based on week number)
        const WEEKLY_CHALLENGES = [
            { id: 'perfect_week', icon: 'üèÜ', name: 'Perfekte Woche', desc: '6/6 Trainings diese Woche', xp: 150, target: 6, getProgress: (stats) => stats.weekTrainings },
            { id: 'protein_week', icon: 'ü•©', name: 'Protein-Woche', desc: '5 Tage Protein-Ziel erreicht', xp: 100, target: 5, getProgress: (stats) => stats.weekProteinDays },
            { id: 'if_week', icon: '‚è∞', name: 'IF-Woche', desc: '6 Tage IF eingehalten', xp: 75, target: 6, getProgress: (stats) => stats.weekIFDays },
            { id: 'weight_down', icon: 'üìâ', name: 'Abw√§rtstrend', desc: 'Gewicht diese Woche reduzieren', xp: 100, target: 1, getProgress: (stats) => stats.weekWeightDown ? 1 : 0 }
        ];

        // XP rewards for actions
        const XP_REWARDS = {
            training: 25,
            proteinGoal: 10,
            ifDone: 5,
            calorieZone: 10,
            logWeight: 3,
            logEntry: 2
        };

        // ============ HELPER FUNCTIONS ============
        function getData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { entries: {}, startWeight: START_WEIGHT, bRotation: 0 };
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(str) {
            return new Date(str + 'T00:00:00');
        }

        function getDayName(date) {
            return ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][date.getDay()];
        }

        // ============ WORKOUT CALCULATION ============
        function getTodayWorkout() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday

            // Saturday is always Cheat Day
            if (dayOfWeek === 6) {
                return 'CHEAT';
            }

            const data = getData();

            // Calculate days since start, excluding Saturdays
            // This ensures strict A-B-A-B rotation based on actual training days
            let dayCount = 0;
            const startDate = new Date(START_DATE);
            const currentDate = new Date(today);
            currentDate.setHours(0, 0, 0, 0);
            startDate.setHours(0, 0, 0, 0);

            for (let d = new Date(startDate); d <= currentDate; d.setDate(d.getDate() + 1)) {
                // Skip Saturdays (Cheat Days don't count in rotation)
                if (d.getDay() !== 6) {
                    dayCount++;
                }
            }

            // Odd days = A (Laufen), Even days = B (Kraft)
            // Day 1 = A, Day 2 = B, Day 3 = A, Day 4 = B, etc.
            const isADay = dayCount % 2 === 1;

            if (isADay) {
                return 'A';
            } else {
                // Determine which B workout based on rotation
                const bRotation = data.bRotation || 0;
                const bWorkouts = ['B1', 'B2', 'B3'];
                return bWorkouts[bRotation % 3];
            }
        }

        function advanceBRotation() {
            const data = getData();
            data.bRotation = ((data.bRotation || 0) + 1) % 3;
            saveData(data);
        }

        // Auto-refresh at midnight
        function scheduleMiddnightRefresh() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setDate(midnight.getDate() + 1);
            midnight.setHours(0, 0, 1, 0); // 00:00:01 next day

            const msUntilMidnight = midnight - now;

            setTimeout(() => {
                updateDashboard();
                updateHistory();
                initForm();
                scheduleMiddnightRefresh(); // Schedule next refresh
            }, msUntilMidnight);
        }

        // ============ STREAK CALCULATION ============
        function calculateStreak() {
            const data = getData();
            const entries = data.entries;
            const sortedDates = Object.keys(entries).sort().reverse();

            let streak = 0;
            let checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);

            // Check if today was already logged
            const todayStr = formatDate(checkDate);
            if (entries[todayStr]?.training) {
                streak = 1;
                checkDate.setDate(checkDate.getDate() - 1);
            }

            // Count backwards
            while (true) {
                const dateStr = formatDate(checkDate);
                const entry = entries[dateStr];

                // Skip Saturdays (Cheat Days)
                if (checkDate.getDay() === 6) {
                    checkDate.setDate(checkDate.getDate() - 1);
                    continue;
                }

                if (entry?.training) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else if (entry) {
                    // Entry exists but no training = streak broken
                    break;
                } else {
                    // No entry = assume streak continues only if within reasonable range
                    break;
                }
            }

            return streak;
        }

        // ============ NEVER MISS TWICE ============
        function checkNeverMissTwice() {
            const data = getData();
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Skip if yesterday was Saturday (Cheat Day)
            if (yesterday.getDay() === 6) return false;

            const yesterdayStr = formatDate(yesterday);
            const entry = data.entries[yesterdayStr];

            // Alert if yesterday had an entry but no training
            return entry && !entry.training;
        }

        // ============ STATS CALCULATION ============
        function getWeeklyAverage() {
            const data = getData();
            const entries = data.entries;
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);

            let weights = [];
            let calories = [];
            let proteins = [];
            let trainingCount = 0;

            for (let d = new Date(weekAgo); d <= today; d.setDate(d.getDate() + 1)) {
                const dateStr = formatDate(d);
                const entry = entries[dateStr];
                if (entry) {
                    if (entry.weight) weights.push(entry.weight);
                    if (entry.calories) calories.push(entry.calories);
                    if (entry.protein) proteins.push(entry.protein);
                    if (entry.training) trainingCount++;
                }
            }

            return {
                weight: weights.length ? (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1) : null,
                calories: calories.length ? Math.round(calories.reduce((a, b) => a + b, 0) / calories.length) : null,
                protein: proteins.length ? Math.round(proteins.reduce((a, b) => a + b, 0) / proteins.length) : null,
                trainingDays: trainingCount
            };
        }

        function getLatestWeight() {
            const data = getData();
            const entries = data.entries;
            const sortedDates = Object.keys(entries).sort().reverse();

            for (const date of sortedDates) {
                if (entries[date].weight) {
                    return entries[date].weight;
                }
            }
            return null;
        }

        function getMonthlyStats() {
            const data = getData();
            const entries = data.entries;
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            let firstWeight = null;
            let lastWeight = null;
            let trainingCount = 0;

            const sortedDates = Object.keys(entries).sort();

            for (const dateStr of sortedDates) {
                const date = parseDate(dateStr);
                if (date >= monthStart && date <= today) {
                    const entry = entries[dateStr];
                    if (entry.weight) {
                        if (!firstWeight) firstWeight = entry.weight;
                        lastWeight = entry.weight;
                    }
                    if (entry.training) trainingCount++;
                }
            }

            return {
                start: firstWeight,
                current: lastWeight,
                change: firstWeight && lastWeight ? (lastWeight - firstWeight).toFixed(1) : null,
                trainings: trainingCount
            };
        }

        // ============ GAMIFICATION FUNCTIONS ============

        function getGamificationData() {
            const data = getData();
            if (!data.gamification) {
                data.gamification = {
                    xp: 0,
                    unlockedMedals: {},
                    completedDailyChallenges: {},
                    completedWeeklyChallenges: {},
                    bestStreak: 0,
                    perfectWeeks: 0
                };
                saveData(data);
            }
            return data.gamification;
        }

        function saveGamificationData(gamData) {
            const data = getData();
            data.gamification = gamData;
            saveData(data);
        }

        function addXP(amount, reason) {
            const gamData = getGamificationData();
            const oldLevel = getCurrentLevel(gamData.xp);
            gamData.xp += amount;
            const newLevel = getCurrentLevel(gamData.xp);
            saveGamificationData(gamData);

            // Check for level up
            if (newLevel.level > oldLevel.level) {
                showReward('üéâ', `Level ${newLevel.level} erreicht!`, `${newLevel.title}`, amount);
            }

            updateXPDisplay();
            return gamData.xp;
        }

        function getCurrentLevel(xp) {
            let currentLevel = LEVELS[0];
            for (const level of LEVELS) {
                if (xp >= level.xpNeeded) {
                    currentLevel = level;
                } else {
                    break;
                }
            }
            return currentLevel;
        }

        function getNextLevel(xp) {
            for (const level of LEVELS) {
                if (xp < level.xpNeeded) {
                    return level;
                }
            }
            return null; // Max level reached
        }

        function calculateStats() {
            const data = getData();
            const entries = data.entries;
            const sortedDates = Object.keys(entries).sort();

            let stats = {
                totalTrainings: 0,
                totalEntries: sortedDates.length,
                weightLost: 0,
                currentWeight: null,
                bestStreak: 0,
                currentStreak: calculateStreak(),
                proteinStreak: 0,
                ifStreak: 0,
                perfectWeeks: 0,
                weekTrainings: 0,
                weekProteinDays: 0,
                weekIFDays: 0,
                weekWeightDown: false,
                q1Reached: false,
                q2Reached: false,
                q3Reached: false,
                q4Reached: false
            };

            // Calculate totals
            let currentProteinStreak = 0;
            let currentIFStreak = 0;
            let weekStart = getWeekStart(new Date());
            let firstWeekWeight = null;
            let lastWeekWeight = null;

            for (const dateStr of sortedDates) {
                const entry = entries[dateStr];
                const entryDate = parseDate(dateStr);

                if (entry.training) stats.totalTrainings++;
                if (entry.weight) stats.currentWeight = entry.weight;

                // Protein streak
                if (entry.protein >= getDynamicProteinGoal()) {
                    currentProteinStreak++;
                    stats.proteinStreak = Math.max(stats.proteinStreak, currentProteinStreak);
                } else {
                    currentProteinStreak = 0;
                }

                // IF streak
                if (entry.if) {
                    currentIFStreak++;
                    stats.ifStreak = Math.max(stats.ifStreak, currentIFStreak);
                } else {
                    currentIFStreak = 0;
                }

                // This week stats
                if (entryDate >= weekStart) {
                    if (entry.training) stats.weekTrainings++;
                    if (entry.protein >= getDynamicProteinGoal()) stats.weekProteinDays++;
                    if (entry.if) stats.weekIFDays++;
                    if (entry.weight) {
                        if (!firstWeekWeight) firstWeekWeight = entry.weight;
                        lastWeekWeight = entry.weight;
                    }
                }
            }

            // Weight loss
            if (stats.currentWeight) {
                stats.weightLost = START_WEIGHT - stats.currentWeight;
            }

            // Week weight down
            if (firstWeekWeight && lastWeekWeight && lastWeekWeight < firstWeekWeight) {
                stats.weekWeightDown = true;
            }

            // Best streak (use gamification data or current)
            const gamData = getGamificationData();
            stats.bestStreak = Math.max(gamData.bestStreak || 0, stats.currentStreak);

            // Update best streak if needed
            if (stats.currentStreak > (gamData.bestStreak || 0)) {
                gamData.bestStreak = stats.currentStreak;
                saveGamificationData(gamData);
            }

            // Perfect weeks
            stats.perfectWeeks = gamData.perfectWeeks || 0;

            // Quarter goals
            const today = new Date();
            if (stats.currentWeight) {
                if (today >= new Date('2026-03-31') && stats.currentWeight <= 99.5) stats.q1Reached = true;
                if (today >= new Date('2026-06-30') && stats.currentWeight <= 95.5) stats.q2Reached = true;
                if (today >= new Date('2026-09-30') && stats.currentWeight <= 92.5) stats.q3Reached = true;
                if (today >= new Date('2026-12-23') && stats.currentWeight <= 89.9) stats.q4Reached = true;
            }

            return stats;
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function checkAndUnlockMedals() {
            const stats = calculateStats();
            const gamData = getGamificationData();
            let newMedals = [];

            for (const medal of MEDALS) {
                if (!gamData.unlockedMedals[medal.id] && medal.check(stats)) {
                    gamData.unlockedMedals[medal.id] = {
                        unlockedAt: new Date().toISOString(),
                        xpAwarded: medal.xp
                    };
                    gamData.xp += medal.xp;
                    newMedals.push(medal);
                }
            }

            saveGamificationData(gamData);

            // Show unlock animation for new medals
            if (newMedals.length > 0) {
                showMedalUnlock(newMedals[0]);
            }

            return newMedals;
        }

        function showMedalUnlock(medal) {
            showReward(medal.icon, 'Neue Medaille!', medal.name, medal.xp);
        }

        function showReward(icon, title, subtitle, xp) {
            document.getElementById('rewardIcon').textContent = icon;
            document.getElementById('rewardTitle').textContent = title;
            document.getElementById('rewardXP').textContent = subtitle + (xp ? ` +${xp} XP` : '');
            document.getElementById('rewardOverlay').classList.add('show');
            document.getElementById('rewardModal').classList.add('show');
        }

        function closeRewardModal() {
            document.getElementById('rewardOverlay').classList.remove('show');
            document.getElementById('rewardModal').classList.remove('show');
            updateXPDisplay();
            updateAchievements();
        }

        function updateXPDisplay() {
            const gamData = getGamificationData();
            const currentLevel = getCurrentLevel(gamData.xp);
            const nextLevel = getNextLevel(gamData.xp);

            document.getElementById('levelIcon').textContent = currentLevel.level;
            document.getElementById('levelTitle').textContent = currentLevel.title;
            document.getElementById('totalXP').textContent = `${gamData.xp} XP gesamt`;

            if (nextLevel) {
                const xpInLevel = gamData.xp - currentLevel.xpNeeded;
                const xpForLevel = nextLevel.xpNeeded - currentLevel.xpNeeded;
                const progress = (xpInLevel / xpForLevel) * 100;
                document.getElementById('xpFill').style.width = `${progress}%`;
                document.getElementById('xpText').textContent = `${xpInLevel} / ${xpForLevel} XP zum Level ${nextLevel.level}`;
            } else {
                document.getElementById('xpFill').style.width = '100%';
                document.getElementById('xpText').textContent = 'MAX LEVEL erreicht!';
            }
        }

        function updateAchievements() {
            const gamData = getGamificationData();
            const stats = calculateStats();
            const data = getData();
            const todayEntry = data.entries[formatDate(new Date())] || {};

            // Update Daily Challenges
            const dailyContainer = document.getElementById('dailyChallenges');
            const today = formatDate(new Date());

            dailyContainer.innerHTML = DAILY_CHALLENGES.map(challenge => {
                const completed = challenge.check(todayEntry);
                const alreadyClaimed = gamData.completedDailyChallenges[today]?.[challenge.id];

                return `
                    <div class="challenge-card ${completed ? 'completed' : 'active'}">
                        <div class="challenge-header">
                            <div class="challenge-title">
                                <span class="icon">${challenge.icon}</span>
                                <span>${challenge.name}</span>
                            </div>
                            <span class="challenge-reward">${alreadyClaimed ? '‚úì' : `+${challenge.xp} XP`}</span>
                        </div>
                        <div class="challenge-status">${challenge.getDesc ? challenge.getDesc() : challenge.desc}</div>
                        <div class="challenge-progress">
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: ${completed ? 100 : 0}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update Weekly Challenge
            const weeklyContainer = document.getElementById('weeklyChallenges');
            const weekNum = getWeekNumber(new Date());
            const weeklyChallenge = WEEKLY_CHALLENGES[weekNum % WEEKLY_CHALLENGES.length];
            const weeklyProgress = weeklyChallenge.getProgress(stats);
            const weeklyCompleted = weeklyProgress >= weeklyChallenge.target;
            const weeklyKey = `${new Date().getFullYear()}-W${weekNum}`;
            const weeklyClaimed = gamData.completedWeeklyChallenges[weeklyKey]?.[weeklyChallenge.id];

            weeklyContainer.innerHTML = `
                <div class="challenge-card weekly-challenge ${weeklyCompleted ? 'completed' : 'active'}">
                    <div class="challenge-header">
                        <div class="challenge-title">
                            <span class="icon">${weeklyChallenge.icon}</span>
                            <span>${weeklyChallenge.name}</span>
                        </div>
                        <span class="challenge-reward">${weeklyClaimed ? '‚úì' : `+${weeklyChallenge.xp} XP`}</span>
                    </div>
                    <div class="challenge-status">${weeklyChallenge.desc}</div>
                    <div class="challenge-progress">
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${Math.min(100, (weeklyProgress / weeklyChallenge.target) * 100)}%"></div>
                        </div>
                        <div class="challenge-status">${weeklyProgress} / ${weeklyChallenge.target}</div>
                    </div>
                </div>
            `;

            // Update Medals Grid
            const medalsContainer = document.getElementById('medalsGrid');
            medalsContainer.innerHTML = MEDALS.map(medal => {
                const unlocked = gamData.unlockedMedals[medal.id];
                const unlockedDate = unlocked ? new Date(unlocked.unlockedAt).toLocaleDateString('de-DE') : '';

                return `
                    <div class="medal-item ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="medal-icon">${medal.icon}</div>
                        <div class="medal-name">${medal.name}</div>
                        <div class="medal-desc">${medal.desc}</div>
                        ${unlocked ? `<div class="medal-date">${unlockedDate}</div>` : ''}
                    </div>
                `;
            }).join('');

            // Update total stats
            document.getElementById('totalTrainings').textContent = stats.totalTrainings;
            document.getElementById('totalMedals').textContent = Object.keys(gamData.unlockedMedals).length;
            document.getElementById('bestStreak').textContent = stats.bestStreak;
        }

        function processDailyXP(entry, isNewEntry) {
            if (!isNewEntry) return;

            const gamData = getGamificationData();
            const today = formatDate(new Date());
            let xpEarned = 0;

            // Initialize daily challenges tracking for today
            if (!gamData.completedDailyChallenges[today]) {
                gamData.completedDailyChallenges[today] = {};
            }

            // Check each daily challenge
            for (const challenge of DAILY_CHALLENGES) {
                if (!gamData.completedDailyChallenges[today][challenge.id] && challenge.check(entry)) {
                    gamData.completedDailyChallenges[today][challenge.id] = true;
                    xpEarned += challenge.xp;
                }
            }

            // Check weekly challenge
            const weekNum = getWeekNumber(new Date());
            const weeklyKey = `${new Date().getFullYear()}-W${weekNum}`;
            const weeklyChallenge = WEEKLY_CHALLENGES[weekNum % WEEKLY_CHALLENGES.length];
            const stats = calculateStats();

            if (!gamData.completedWeeklyChallenges[weeklyKey]) {
                gamData.completedWeeklyChallenges[weeklyKey] = {};
            }

            if (!gamData.completedWeeklyChallenges[weeklyKey][weeklyChallenge.id]) {
                const progress = weeklyChallenge.getProgress(stats);
                if (progress >= weeklyChallenge.target) {
                    gamData.completedWeeklyChallenges[weeklyKey][weeklyChallenge.id] = true;
                    xpEarned += weeklyChallenge.xp;

                    // Track perfect weeks
                    if (weeklyChallenge.id === 'perfect_week') {
                        gamData.perfectWeeks = (gamData.perfectWeeks || 0) + 1;
                    }
                }
            }

            if (xpEarned > 0) {
                gamData.xp += xpEarned;
                saveGamificationData(gamData);
            }

            // Check for new medals
            checkAndUnlockMedals();

            updateXPDisplay();
            updateAchievements();
        }

        // ============ CHART FUNCTIONS ============
        let currentChartDays = 30;

        function getWeightData(days) {
            const data = getData();
            const entries = data.entries;
            const sortedDates = Object.keys(entries).sort();

            let weights = [];
            const today = new Date();
            const cutoffDate = days > 0 ? new Date(today.getTime() - days * 24 * 60 * 60 * 1000) : null;

            for (const dateStr of sortedDates) {
                const entry = entries[dateStr];
                const entryDate = parseDate(dateStr);

                if (entry.weight && (!cutoffDate || entryDate >= cutoffDate)) {
                    weights.push({
                        date: entryDate,
                        dateStr: dateStr,
                        weight: entry.weight
                    });
                }
            }

            return weights;
        }

        function calculateMovingAverage(weights, windowSize = 7) {
            return weights.map((point, index) => {
                const start = Math.max(0, index - windowSize + 1);
                const subset = weights.slice(start, index + 1);
                const avg = subset.reduce((sum, p) => sum + p.weight, 0) / subset.length;
                return {
                    date: point.date,
                    weight: avg
                };
            });
        }

        function drawChart(days = currentChartDays) {
            currentChartDays = days;
            const canvas = document.getElementById('weightChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;

            // Set canvas size for high DPI
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = 250 * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = '250px';
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = 250;
            const padding = { top: 20, right: 20, bottom: 40, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Get data
            const weights = getWeightData(days);

            if (weights.length < 2) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Noch nicht genug Daten', width / 2, height / 2);
                ctx.fillText('(mindestens 2 Gewichtseintr√§ge n√∂tig)', width / 2, height / 2 + 20);
                updateChartStats(weights);
                return;
            }

            // Calculate ranges
            const allWeights = weights.map(w => w.weight);
            const minWeight = Math.min(...allWeights, GOAL_WEIGHT) - 1;
            const maxWeight = Math.max(...allWeights, START_WEIGHT) + 1;
            const weightRange = maxWeight - minWeight;

            const minDate = weights[0].date;
            const maxDate = weights[weights.length - 1].date;
            const dateRange = maxDate - minDate || 1;

            // Helper functions
            const xScale = (date) => padding.left + ((date - minDate) / dateRange) * chartWidth;
            const yScale = (weight) => padding.top + ((maxWeight - weight) / weightRange) * chartHeight;

            // Draw grid lines
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;

            // Horizontal grid lines (weight)
            const yGridCount = 5;
            for (let i = 0; i <= yGridCount; i++) {
                const y = padding.top + (i / yGridCount) * chartHeight;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();

                // Y-axis labels
                const weight = maxWeight - (i / yGridCount) * weightRange;
                ctx.fillStyle = '#64748b';
                ctx.font = '11px -apple-system, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(weight.toFixed(1), padding.left - 8, y + 4);
            }

            // Goal line
            const goalY = yScale(GOAL_WEIGHT);
            ctx.strokeStyle = 'rgba(245, 158, 11, 0.5)';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding.left, goalY);
            ctx.lineTo(width - padding.right, goalY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw 7-day moving average
            const movingAvg = calculateMovingAverage(weights);
            if (movingAvg.length > 1) {
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 2;
                ctx.beginPath();
                movingAvg.forEach((point, i) => {
                    const x = xScale(point.date);
                    const y = yScale(point.weight);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            }

            // Draw weight line
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            weights.forEach((point, i) => {
                const x = xScale(point.date);
                const y = yScale(point.weight);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Draw data points
            weights.forEach(point => {
                const x = xScale(point.date);
                const y = yScale(point.weight);

                ctx.fillStyle = '#3b82f6';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#1e293b';
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, Math.PI * 2);
                ctx.fill();
            });

            // X-axis date labels
            ctx.fillStyle = '#64748b';
            ctx.font = '10px -apple-system, sans-serif';
            ctx.textAlign = 'center';

            const labelCount = Math.min(weights.length, 6);
            const step = Math.floor(weights.length / labelCount);

            for (let i = 0; i < weights.length; i += step) {
                const point = weights[i];
                const x = xScale(point.date);
                const dateLabel = point.dateStr.slice(5); // MM-DD
                ctx.fillText(dateLabel, x, height - 10);
            }

            // Always show last date
            if (weights.length > 0) {
                const lastPoint = weights[weights.length - 1];
                const x = xScale(lastPoint.date);
                const dateLabel = lastPoint.dateStr.slice(5);
                ctx.fillText(dateLabel, x, height - 10);
            }

            // Update stats
            updateChartStats(weights);
        }

        function updateChartStats(weights) {
            if (weights.length === 0) {
                document.getElementById('chartHighest').textContent = '--';
                document.getElementById('chartLowest').textContent = '--';
                document.getElementById('chartAverage').textContent = '--';
                document.getElementById('chartChange').textContent = '--';
                document.getElementById('projectionTitle').textContent = 'Keine Daten';
                document.getElementById('projectionText').textContent = 'Trage dein Gewicht ein, um eine Prognose zu sehen.';
                return;
            }

            const allWeights = weights.map(w => w.weight);
            const highest = Math.max(...allWeights);
            const lowest = Math.min(...allWeights);
            const average = allWeights.reduce((a, b) => a + b, 0) / allWeights.length;
            const change = weights.length > 1 ? allWeights[allWeights.length - 1] - allWeights[0] : 0;

            document.getElementById('chartHighest').textContent = highest.toFixed(1) + ' kg';
            document.getElementById('chartLowest').textContent = lowest.toFixed(1) + ' kg';
            document.getElementById('chartAverage').textContent = average.toFixed(1) + ' kg';
            document.getElementById('chartChange').textContent = (change > 0 ? '+' : '') + change.toFixed(1) + ' kg';

            const changeBox = document.getElementById('chartChangeBox');
            changeBox.classList.remove('positive', 'negative');
            if (change < 0) changeBox.classList.add('positive');
            else if (change > 0) changeBox.classList.add('negative');

            // Calculate projection
            if (weights.length >= 7) {
                const firstWeek = weights.slice(0, 7);
                const lastWeek = weights.slice(-7);
                const firstAvg = firstWeek.reduce((s, p) => s + p.weight, 0) / firstWeek.length;
                const lastAvg = lastWeek.reduce((s, p) => s + p.weight, 0) / lastWeek.length;

                const daysDiff = (weights[weights.length - 1].date - weights[0].date) / (1000 * 60 * 60 * 24);
                const weeklyChange = daysDiff > 0 ? ((lastAvg - firstAvg) / daysDiff) * 7 : 0;

                document.getElementById('weeklyLoss').textContent = (weeklyChange > 0 ? '+' : '') + weeklyChange.toFixed(2) + ' kg';

                const currentWeight = allWeights[allWeights.length - 1];
                if (weeklyChange < 0 && currentWeight > GOAL_WEIGHT) {
                    const kgToLose = currentWeight - GOAL_WEIGHT;
                    const weeksNeeded = kgToLose / Math.abs(weeklyChange);
                    const daysNeeded = Math.ceil(weeksNeeded * 7);
                    const goalDate = new Date();
                    goalDate.setDate(goalDate.getDate() + daysNeeded);

                    document.getElementById('daysToGoal').textContent = daysNeeded;
                    document.getElementById('projectionTitle').textContent = 'üéØ Ziel erreichbar!';
                    document.getElementById('projectionText').textContent =
                        `Bei aktuellem Tempo erreichst du ${GOAL_WEIGHT} kg am ${goalDate.toLocaleDateString('de-DE')}.`;
                } else if (currentWeight <= GOAL_WEIGHT) {
                    document.getElementById('daysToGoal').textContent = '‚úì';
                    document.getElementById('projectionTitle').textContent = 'üèÜ Ziel erreicht!';
                    document.getElementById('projectionText').textContent = 'Du hast dein Zielgewicht erreicht!';
                } else {
                    document.getElementById('daysToGoal').textContent = '‚àû';
                    document.getElementById('projectionTitle').textContent = 'üìà Trend anpassen';
                    document.getElementById('projectionText').textContent =
                        'Aktuell kein Abw√§rtstrend. Fokus auf Kaloriendefizit und Training!';
                }
            } else {
                document.getElementById('weeklyLoss').textContent = '--';
                document.getElementById('daysToGoal').textContent = '--';
                document.getElementById('projectionTitle').textContent = 'Mehr Daten ben√∂tigt';
                document.getElementById('projectionText').textContent =
                    'Mindestens 7 Gewichtseintr√§ge f√ºr eine Prognose n√∂tig.';
            }
        }

        function initChartTab() {
            // Time filter buttons
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    drawChart(parseInt(btn.dataset.days));
                });
            });

            // Redraw on window resize
            window.addEventListener('resize', () => {
                if (document.getElementById('charts').classList.contains('active')) {
                    drawChart(currentChartDays);
                }
            });
        }

        // ============ UI UPDATE FUNCTIONS ============
        function updateDashboard() {
            const data = getData();
            const latestWeight = getLatestWeight();
            const weeklyStats = getWeeklyAverage();
            const streak = calculateStreak();
            const todayWorkout = getTodayWorkout();

            // Progress
            if (latestWeight) {
                document.getElementById('currentWeight').textContent = `${latestWeight} kg`;
                const lost = (START_WEIGHT - latestWeight).toFixed(1);
                const toGo = (latestWeight - GOAL_WEIGHT).toFixed(1);
                const progress = ((START_WEIGHT - latestWeight) / (START_WEIGHT - GOAL_WEIGHT)) * 100;

                document.getElementById('weightLost').textContent = lost;
                document.getElementById('weightToGo').textContent = toGo;
                document.getElementById('progressFill').style.width = `${Math.min(100, Math.max(0, progress))}%`;
            }

            // Days left and current date display
            const today = new Date();
            const daysLeft = Math.ceil((GOAL_DATE - today) / (1000 * 60 * 60 * 24));
            document.getElementById('daysLeft').textContent = daysLeft;

            // Show current date in header
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('currentDate').textContent =
                `Heute: ${today.toLocaleDateString('de-DE', dateOptions)}`;

            // Weekly average
            document.getElementById('weeklyAvg').textContent = weeklyStats.weight ? `${weeklyStats.weight}` : '--';
            document.getElementById('avgCalories').textContent = weeklyStats.calories || '--';
            document.getElementById('avgProtein').textContent = weeklyStats.protein ? `${weeklyStats.protein}g` : '--';
            document.getElementById('trainingDays').textContent = `${weeklyStats.trainingDays}/7`;

            // Streak
            document.getElementById('streakCount').textContent = streak;

            // Today's workout
            const workout = WORKOUTS[todayWorkout];
            const badge = document.getElementById('todayBadge');
            badge.textContent = workout.name;
            badge.className = `training-badge ${workout.badge}`;
            document.getElementById('todayWorkout').innerHTML = `<p>${workout.details}</p>`;

            // Never miss twice alert
            const alertBanner = document.getElementById('alertBanner');
            if (checkNeverMissTwice()) {
                alertBanner.classList.add('show');
            } else {
                alertBanner.classList.remove('show');
            }

            // Quarter goals
            updateQuarterGoals(latestWeight);

            // Scientific goals (BMI, Protein, etc.)
            updateScientificGoals();
        }

        function updateQuarterGoals(currentWeight) {
            const container = document.getElementById('quarterGoals');
            const today = new Date();

            container.innerHTML = QUARTER_GOALS.map(q => {
                let status = 'future';
                let icon = '‚è≥';

                if (today > q.date) {
                    status = currentWeight && currentWeight <= q.target ? 'achieved' : 'future';
                    icon = currentWeight && currentWeight <= q.target ? '‚úÖ' : '‚ùå';
                } else if (today <= q.date && (QUARTER_GOALS.indexOf(q) === 0 || today > QUARTER_GOALS[QUARTER_GOALS.indexOf(q) - 1]?.date)) {
                    status = 'current';
                    icon = 'üéØ';
                }

                return `
                    <div class="quarter-item ${status}">
                        <span>${icon} ${q.label}</span>
                        <span>${q.target} kg</span>
                    </div>
                `;
            }).join('');
        }

        function updateHistory() {
            const data = getData();
            const entries = data.entries;
            const container = document.getElementById('historyList');

            const sortedDates = Object.keys(entries).sort().reverse().slice(0, 14);

            if (sortedDates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">Noch keine Eintr√§ge</p>';
                return;
            }

            container.innerHTML = sortedDates.map(dateStr => {
                const entry = entries[dateStr];
                const date = parseDate(dateStr);

                return `
                    <div class="history-item">
                        <div class="history-date">
                            <strong>${getDayName(date)}</strong><br>
                            ${dateStr.slice(5)}
                        </div>
                        <div class="history-data">
                            ${entry.weight ? `<span class="history-tag">${entry.weight} kg</span>` : ''}
                            ${entry.training ? '<span class="history-tag success">‚úÖ Training</span>' : '<span class="history-tag warning">‚ùå Kein Training</span>'}
                            ${entry.calories ? `<span class="history-tag">${entry.calories} kcal</span>` : ''}
                            ${entry.protein ? `<span class="history-tag">${entry.protein}g Protein</span>` : ''}
                            ${entry.if ? '<span class="history-tag success">IF ‚úì</span>' : ''}
                            ${entry.cheat ? '<span class="history-tag" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">üçï Cheat</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Monthly stats
            const monthly = getMonthlyStats();
            document.getElementById('monthStart').textContent = monthly.start ? `${monthly.start} kg` : '--';
            document.getElementById('monthCurrent').textContent = monthly.current ? `${monthly.current} kg` : '--';
            document.getElementById('monthChange').textContent = monthly.change ? `${monthly.change} kg` : '--';
            document.getElementById('monthChange').className = `value ${parseFloat(monthly.change) < 0 ? 'trend-down' : 'trend-up'}`;
            document.getElementById('monthTrainings').textContent = monthly.trainings;
        }

        // ============ FORM HANDLING ============
        function initForm() {
            const dateInput = document.getElementById('entryDate');
            dateInput.value = formatDate(new Date());

            // Load existing entry for today
            loadEntryForDate(dateInput.value);

            dateInput.addEventListener('change', (e) => {
                loadEntryForDate(e.target.value);
            });
        }

        function loadEntryForDate(dateStr) {
            const data = getData();
            const entry = data.entries[dateStr] || {};

            document.getElementById('entryCalories').value = entry.calories || '';
            document.getElementById('entryProtein').value = entry.protein || '';
            document.getElementById('trainingDone').checked = entry.training || false;
            document.getElementById('ifDone').checked = entry.if || false;
            document.getElementById('cheatDay').checked = entry.cheat || false;

            updateQuickStats(entry);
        }

        function updateQuickStats(entry) {
            const proteinEl = document.getElementById('proteinStatus');
            const calorieEl = document.getElementById('calorieStatus');

            if (entry.protein) {
                const proteinOk = entry.protein >= getDynamicProteinGoal();
                proteinEl.textContent = `${entry.protein}g`;
                proteinEl.style.color = proteinOk ? 'var(--success)' : 'var(--warning)';
            } else {
                proteinEl.textContent = '--';
                proteinEl.style.color = '';
            }

            if (entry.calories) {
                const inRange = entry.calories >= 2100 && entry.calories <= 2400;
                calorieEl.textContent = entry.calories;
                calorieEl.style.color = inRange ? 'var(--success)' : 'var(--warning)';
            } else {
                calorieEl.textContent = '--';
                calorieEl.style.color = '';
            }
        }

        // ============ EVENT LISTENERS ============
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');

                    if (tab.dataset.tab === 'history') {
                        updateHistory();
                    }
                    if (tab.dataset.tab === 'achievements') {
                        updateAchievements();
                    }
                    if (tab.dataset.tab === 'charts') {
                        drawChart(currentChartDays);
                    }
                });
            });

            // Form submission
            document.getElementById('dailyForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const dateStr = document.getElementById('entryDate').value;
                const data = getData();

                const wasTrainingBefore = data.entries[dateStr]?.training;
                const isTrainingNow = document.getElementById('trainingDone').checked;

                // Preserve existing weight data (weight is entered separately in Grafik tab)
                const existingWeight = data.entries[dateStr]?.weight || null;

                const entry = {
                    weight: existingWeight,
                    calories: parseInt(document.getElementById('entryCalories').value) || null,
                    protein: parseInt(document.getElementById('entryProtein').value) || null,
                    training: isTrainingNow,
                    if: document.getElementById('ifDone').checked,
                    cheat: document.getElementById('cheatDay').checked
                };

                data.entries[dateStr] = entry;

                // Advance B rotation if this is a new B-day training
                if (!wasTrainingBefore && isTrainingNow) {
                    const todayWorkout = getTodayWorkout();
                    if (todayWorkout.startsWith('B')) {
                        advanceBRotation();
                    }
                }

                saveData(data);

                // Process gamification XP and check achievements
                const isNewEntry = !wasTrainingBefore ||
                    entry.protein !== data.entries[dateStr]?.protein ||
                    entry.if !== data.entries[dateStr]?.if;
                processDailyXP(entry, true);

                updateQuickStats(entry);
                updateDashboard();
                updateXPDisplay();

                // Visual feedback
                const btn = e.target.querySelector('button');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Gespeichert!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });

            // Weight form submission (in Grafik tab)
            document.getElementById('weightForm').addEventListener('submit', (e) => {
                e.preventDefault();

                const dateStr = document.getElementById('weightDate').value;
                const weight = parseFloat(document.getElementById('weightValue').value);

                if (!dateStr || !weight) return;

                const data = getData();

                // Create or update entry for this date
                if (!data.entries[dateStr]) {
                    data.entries[dateStr] = {};
                }
                data.entries[dateStr].weight = weight;

                saveData(data);

                // Update displays
                updateDashboard();
                drawChart(currentChartDays);
                updateChartStats(currentChartDays);

                // Add XP for logging weight
                addXP(XP_REWARDS.logWeight, 'Gewicht eingetragen');

                // Visual feedback
                const btn = e.target.querySelector('button');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Gespeichert!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);

                // Clear weight input for next entry
                document.getElementById('weightValue').value = '';
            });

            // Initialize weight form date to today
            document.getElementById('weightDate').value = formatDate(new Date());

            // Initialize
            initForm();
            initSettings();
            updateDashboard();
            updateXPDisplay();
            updateAchievements();
            initChartTab();
            scheduleMiddnightRefresh(); // Auto-update at midnight
        });

        // ============ SETTINGS FUNCTIONS ============
        function initSettings() {
            const settings = getUserSettings();

            // Slider f√ºr Gr√∂√üe
            const heightSlider = document.getElementById('settingHeight');
            const heightValue = document.getElementById('heightValue');
            heightSlider.value = settings.height;
            heightValue.textContent = `${settings.height} cm`;

            heightSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                heightValue.textContent = `${value} cm`;
                const newSettings = getUserSettings();
                newSettings.height = value;
                saveUserSettings(newSettings);
            });

            // Slider f√ºr Alter
            const ageSlider = document.getElementById('settingAge');
            const ageValue = document.getElementById('ageValue');
            ageSlider.value = settings.age;
            ageValue.textContent = `${settings.age} Jahre`;

            ageSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                ageValue.textContent = `${value} Jahre`;
                const newSettings = getUserSettings();
                newSettings.age = value;
                saveUserSettings(newSettings);
            });

            // Gender Buttons
            document.querySelectorAll('.gender-btn').forEach(btn => {
                if (btn.dataset.gender === settings.gender) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }

                btn.addEventListener('click', () => {
                    document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const newSettings = getUserSettings();
                    newSettings.gender = btn.dataset.gender;
                    saveUserSettings(newSettings);
                });
            });

            // Activity Buttons
            document.querySelectorAll('.activity-btn').forEach(btn => {
                if (btn.dataset.activity === settings.activity) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }

                btn.addEventListener('click', () => {
                    document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const newSettings = getUserSettings();
                    newSettings.activity = btn.dataset.activity;
                    saveUserSettings(newSettings);
                });
            });

            // Initial preview update
            updateSettingsPreview();
        }

        function updateSettingsPreview() {
            const settings = getUserSettings();
            const weight = getLatestWeight() || 100; // Fallback f√ºr Vorschau
            const activity = ACTIVITY_LEVELS[settings.activity];
            const heightM = settings.height / 100;

            // BMI
            const bmi = weight / (heightM * heightM);

            // BMR (Mifflin-St Jeor)
            const genderOffset = settings.gender === 'male' ? 5 : -161;
            const bmr = 10 * weight + 6.25 * settings.height - 5 * settings.age + genderOffset;

            // TDEE
            const tdee = bmr * activity.pal;

            // Protein
            const protein = Math.round(weight * activity.proteinFactor);

            // Ideal weight
            const idealWeight = Math.round(22 * heightM * heightM * 10) / 10;

            const previewContainer = document.getElementById('settingsPreview');
            previewContainer.innerHTML = `
                <div class="preview-item">
                    <div class="value">${bmi.toFixed(1)}</div>
                    <div class="label">BMI (bei ${weight}kg)</div>
                </div>
                <div class="preview-item">
                    <div class="value">${Math.round(bmr)}</div>
                    <div class="label">Grundumsatz (kcal)</div>
                </div>
                <div class="preview-item">
                    <div class="value">${Math.round(tdee)}</div>
                    <div class="label">Tagesbedarf (kcal)</div>
                </div>
                <div class="preview-item">
                    <div class="value">${Math.round(tdee - 500)}</div>
                    <div class="label">Defizit -500 (kcal)</div>
                </div>
                <div class="preview-item">
                    <div class="value">${protein}g</div>
                    <div class="label">Protein/Tag</div>
                </div>
                <div class="preview-item">
                    <div class="value">${idealWeight}kg</div>
                    <div class="label">Idealgewicht</div>
                </div>
            `;
        }
    </script>
</body>
</html>
